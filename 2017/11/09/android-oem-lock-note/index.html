<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="Android Socket 应用 - 网络编程与进程通讯"/>







  <link rel="alternate" href="/atom.xml" title="4ndroidev Note">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.png?v=2.4.x" />



<link rel="canonical" href="http://4ndroidev.github.io/2017/11/09/android-oem-lock-note/"/>


<meta name="description" content="前阵子空闲时间学习了下 okhttp 源码，主要是重新学习 socket 网络编程，以及 okhttp 框架的一些特点。上周末，一个制作三星刷机包的朋友告诉我：国行三星手机通过官方 crom service 应用解锁手机后，才可以刷第三方刷机包，解锁后就保修就废了，很多人都不愿意解锁。于是朋友托我研究 crom service 上锁，如果研究成功，那么玩家更乐意解锁刷机。在研究上锁，刚好涉及到 a">
<meta property="og:type" content="article">
<meta property="og:title" content="Android Socket 应用 - 网络编程与进程通讯">
<meta property="og:url" content="http://4ndroidev.github.io/2017/11/09/android-oem-lock-note/index.html">
<meta property="og:site_name" content="4ndroidev Note">
<meta property="og:description" content="前阵子空闲时间学习了下 okhttp 源码，主要是重新学习 socket 网络编程，以及 okhttp 框架的一些特点。上周末，一个制作三星刷机包的朋友告诉我：国行三星手机通过官方 crom service 应用解锁手机后，才可以刷第三方刷机包，解锁后就保修就废了，很多人都不愿意解锁。于是朋友托我研究 crom service 上锁，如果研究成功，那么玩家更乐意解锁刷机。在研究上锁，刚好涉及到 a">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="http://4ndroidev.github.io/images/android-socket/android-ps-ls-vold.png">
<meta property="og:image" content="http://4ndroidev.github.io/images/android-socket/android-libkwb-jar.png">
<meta property="og:image" content="http://4ndroidev.github.io/images/android-socket/android-as-locker.png">
<meta property="og:image" content="http://4ndroidev.github.io/images/android-socket/android-libkwb-native-unlock.png">
<meta property="og:image" content="http://4ndroidev.github.io/images/android-socket/android-libkwb-sub1994.png">
<meta property="og:image" content="http://4ndroidev.github.io/images/android-socket/android-libkwb-hex.png">
<meta property="og:image" content="http://4ndroidev.github.io/images/android-socket/android-samsung-bl.png">
<meta property="og:updated_time" content="2017-11-08T07:03:10.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android Socket 应用 - 网络编程与进程通讯">
<meta name="twitter:description" content="前阵子空闲时间学习了下 okhttp 源码，主要是重新学习 socket 网络编程，以及 okhttp 框架的一些特点。上周末，一个制作三星刷机包的朋友告诉我：国行三星手机通过官方 crom service 应用解锁手机后，才可以刷第三方刷机包，解锁后就保修就废了，很多人都不愿意解锁。于是朋友托我研究 crom service 上锁，如果研究成功，那么玩家更乐意解锁刷机。在研究上锁，刚好涉及到 a">
<meta name="twitter:image" content="http://4ndroidev.github.io/images/android-socket/android-ps-ls-vold.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.4.x" />







<script>
  var CONFIG = {
    search: false,
    searchPath: "/search.xml",
    fancybox: false,
    toc: true,
  }
</script>




  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?c74a9833e61718f98aa60cb651862c4d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




    <title> Android Socket 应用 - 网络编程与进程通讯 · 4ndroidev Note </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">4ndroidev Note</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">4ndroidev Note</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Android Socket 应用 - 网络编程与进程通讯
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年11月9日
        </span>
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#socket-网络编程"><span class="toc-text">socket 网络编程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#请求信息"><span class="toc-text">请求信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#响应信息"><span class="toc-text">响应信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#socket-进程通讯"><span class="toc-text">socket 进程通讯</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#服务器启动"><span class="toc-text">服务器启动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#脚本解释"><span class="toc-text">脚本解释</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动服务"><span class="toc-text">启动服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#程序运行"><span class="toc-text">程序运行</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端连接"><span class="toc-text">客户端连接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三星上锁"><span class="toc-text">三星上锁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#引用"><span class="toc-text">引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <p>前阵子空闲时间学习了下 okhttp 源码，主要是重新学习 socket 网络编程，以及 okhttp 框架的一些特点。上周末，一个制作三星刷机包的朋友告诉我：国行三星手机通过官方 crom service 应用解锁手机后，才可以刷第三方刷机包，解锁后就保修就废了，很多人都不愿意解锁。于是朋友托我研究 crom service 上锁，如果研究成功，那么玩家更乐意解锁刷机。在研究上锁，刚好涉及到 android 底层 socket 通讯知识，同时分享下。文末介绍这次三星上锁之旅（反编译相关），成功但尴尬的结局。</p>
<h2 id="socket-网络编程"><a href="#socket-网络编程" class="headerlink" title="socket 网络编程"></a>socket 网络编程</h2><p>在 okhttp 中，一次网络请求，在一条拦截链中完成，拦截链中每个拦截器完成比较少的任务（如重定向，失败重连，连接池，缓存等），很多大神也分享过拦截链的代码，就不重复介绍，这里主要介绍一次网络请求整个流程，可分以下四步：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>connectSocket</td>
<td>通过 socket 连接远程服务器</td>
</tr>
<tr>
<td>2</td>
<td>connectTls</td>
<td>传输层安全协议，握手</td>
</tr>
<tr>
<td>3</td>
<td>writeRequest</td>
<td>写请求信息</td>
</tr>
<tr>
<td>4</td>
<td>readResponse</td>
<td>读响应信息</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<p>以下代码为整合的一次 https 网络请求代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Https</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIMEOUT = <span class="number">5000</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PORT = <span class="number">443</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Socket socket;</div><div class="line">    <span class="keyword">private</span> Request request;</div><div class="line">    <span class="keyword">private</span> BufferedSink sink;</div><div class="line">    <span class="keyword">private</span> BufferedSource source;</div><div class="line">    <span class="keyword">private</span> Callback callback;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Https</span><span class="params">(Request request, Callback callback)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.request = request;</div><div class="line">        <span class="keyword">this</span>.callback = callback;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            connectSocket();</div><div class="line">            connectTls();</div><div class="line">            writeRequest();</div><div class="line">            readResponse();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            closeQuietly();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">connectSocket</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        socket = <span class="keyword">new</span> Socket();</div><div class="line">        socket.connect(<span class="keyword">new</span> InetSocketAddress(request.url().host(), PORT), TIMEOUT);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">connectTls</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        String host = request.url().host();</div><div class="line">        X509TrustManager trustManager = systemDefaultTrustManager();</div><div class="line">        SSLSocketFactory sslSocketFactory = systemDefaultSslSocketFactory(trustManager);</div><div class="line">        SSLSocket sslSocket = (SSLSocket) sslSocketFactory.createSocket(socket, host, PORT, <span class="keyword">true</span>);</div><div class="line">        Platform.get().configureTlsExtensions(sslSocket, host, Util.immutableList(Protocol.HTTP_2, Protocol.HTTP_1_1));</div><div class="line">        sslSocket.startHandshake();</div><div class="line">        Handshake unverifiedHandshake = Handshake.get(sslSocket.getSession());</div><div class="line">        <span class="keyword">if</span> (!OkHostnameVerifier.INSTANCE.verify(host, sslSocket.getSession())) &#123;</div><div class="line">            sslSocket.close();</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        CertificatePinner.DEFAULT.check(host, unverifiedHandshake.peerCertificates());</div><div class="line">        socket = sslSocket;</div><div class="line">        sink = Okio.buffer(Okio.sink(socket.getOutputStream()));</div><div class="line">        source = Okio.buffer(Okio.source(socket.getInputStream()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rebuildRequest</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        Request.Builder requestBuilder = request.newBuilder();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (request.header(<span class="string">"Host"</span>) == <span class="keyword">null</span>) &#123;</div><div class="line">            requestBuilder.header(<span class="string">"Host"</span>, Util.hostHeader(request.url(), <span class="keyword">false</span>));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (request.header(<span class="string">"User-Agent"</span>) == <span class="keyword">null</span>) &#123;</div><div class="line">            requestBuilder.header(<span class="string">"User-Agent"</span>, Version.userAgent());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        request = requestBuilder.build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeRequest</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        rebuildRequest();</div><div class="line">        Headers headers = request.headers();</div><div class="line">        sink.writeUtf8(RequestLine.get(request, Proxy.Type.HTTP)).writeUtf8(<span class="string">"\r\n"</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = headers.size(); i &lt; size; i++) &#123;</div><div class="line">            sink.writeUtf8(headers.name(i)).writeUtf8(<span class="string">": "</span>).writeUtf8(headers.value(i)).writeUtf8(<span class="string">"\r\n"</span>);</div><div class="line">        &#125;</div><div class="line">        sink.writeUtf8(<span class="string">"\r\n"</span>);</div><div class="line">        RequestBody requestBody = request.body();</div><div class="line">        <span class="keyword">if</span> (requestBody != <span class="keyword">null</span>) &#123;</div><div class="line">            requestBody.writeTo(sink);</div><div class="line">        &#125;</div><div class="line">        sink.close();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readResponse</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        StatusLine statusLine = StatusLine.parse(source.readUtf8LineStrict());</div><div class="line">        Headers.Builder headers = <span class="keyword">new</span> Headers.Builder();</div><div class="line">        <span class="keyword">for</span> (String line; (line = source.readUtf8LineStrict()).length() != <span class="number">0</span>; ) &#123;</div><div class="line">            <span class="keyword">int</span> index = line.indexOf(<span class="string">":"</span>, <span class="number">1</span>);</div><div class="line">            <span class="keyword">if</span> (index != -<span class="number">1</span>) &#123;</div><div class="line">                headers.add(line.substring(<span class="number">0</span>, index), line.substring(index + <span class="number">1</span>));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        Response response = <span class="keyword">new</span> Response.Builder()</div><div class="line">                .request(request)</div><div class="line">                .protocol(statusLine.protocol)</div><div class="line">                .code(statusLine.code)</div><div class="line">                .message(statusLine.message)</div><div class="line">                .headers(headers.build())</div><div class="line">                .build();</div><div class="line">        <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">byte</span>[] data;</div><div class="line">            <span class="keyword">if</span> (!HttpHeaders.hasBody(response)) &#123;</div><div class="line">                data = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">long</span> contentLength = HttpHeaders.contentLength(response);</div><div class="line">                <span class="keyword">if</span> (contentLength != -<span class="number">1</span>) &#123;</div><div class="line">                    <span class="keyword">long</span> bytesRemaining = contentLength;</div><div class="line">                    <span class="keyword">long</span> bytesCount = <span class="number">1024</span>;</div><div class="line">                    Buffer buffer = <span class="keyword">new</span> Buffer();</div><div class="line">                    <span class="keyword">while</span> (bytesRemaining &gt; <span class="number">0</span>) &#123;</div><div class="line">                        bytesCount = source.read(buffer, Math.min(bytesRemaining, bytesCount));</div><div class="line">                        bytesRemaining -= bytesCount;</div><div class="line">                    &#125;</div><div class="line">                    data = buffer.readByteArray();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    data = source.readByteArray();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            callback.response(data);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeQuietly</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (socket != <span class="keyword">null</span>) &#123;</div><div class="line">                socket.close();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (sink != <span class="keyword">null</span>) &#123;</div><div class="line">                sink.close();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (source != <span class="keyword">null</span>) &#123;</div><div class="line">                source.close();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> X509TrustManager <span class="title">systemDefaultTrustManager</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            TrustManagerFactory trustManagerFactory = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());</div><div class="line">            trustManagerFactory.init((KeyStore) <span class="keyword">null</span>);</div><div class="line">            TrustManager[] trustManagers = trustManagerFactory.getTrustManagers();</div><div class="line">            <span class="keyword">if</span> (trustManagers.length != <span class="number">1</span> || !(trustManagers[<span class="number">0</span>] <span class="keyword">instanceof</span> X509TrustManager)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unexpected default trust managers:"</span></div><div class="line">                        + Arrays.toString(trustManagers));</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> (X509TrustManager) trustManagers[<span class="number">0</span>];</div><div class="line">        &#125; <span class="keyword">catch</span> (GeneralSecurityException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(); <span class="comment">// The system has no TLS. Just give up.</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> SSLSocketFactory <span class="title">systemDefaultSslSocketFactory</span><span class="params">(X509TrustManager trustManager)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            SSLContext sslContext = SSLContext.getInstance(<span class="string">"TLS"</span>);</div><div class="line">            sslContext.init(<span class="keyword">null</span>, <span class="keyword">new</span> TrustManager[]&#123;trustManager&#125;, <span class="keyword">null</span>);</div><div class="line">            <span class="keyword">return</span> sslContext.getSocketFactory();</div><div class="line">        &#125; <span class="keyword">catch</span> (GeneralSecurityException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(); <span class="comment">// The system has no TLS. Just give up.</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">response</span><span class="params">(<span class="keyword">byte</span>[] data)</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述代码，如果不关心<strong>传输层安全协议</strong>，看上去还是挺简单的，先连接远程服务器，然后建立 SSLSocket ，获取输入输出流，然后写请求信息，即可得到响应消息。满足 http 其中三个特点：1. C/S模式；2. 快速简单，支持多种请求方式； 3. 灵活，支持任意类型数据对象。</p>
<h3 id="请求信息"><a href="#请求信息" class="headerlink" title="请求信息"></a>请求信息</h3><p>请求格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;request-line&gt;</div><div class="line">&lt;headers&gt;</div><div class="line">&lt;blank line&gt;</div><div class="line">[&lt;request-body&gt;]</div></pre></td></tr></table></figure>
<ol>
<li>第一行，请求行，说明请求类型，请求资源路径以及 http 版本</li>
<li>第二行开始为请求头信息，直至空行，一般包含<strong> User-Agent </strong>和<strong> Host </strong></li>
<li>空行</li>
<li>最后为请求传输的内容，可能为空</li>
</ol>
<p>举例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">GET /repos/4ndroidev/DownloadManager/issues?state=closed HTTP/1.1</div><div class="line">Host: api.github.com</div><div class="line">User-Agent: okhttp/3.8.1</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure>
<h3 id="响应信息"><a href="#响应信息" class="headerlink" title="响应信息"></a>响应信息</h3><p>响应格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;status-line&gt;</div><div class="line">&lt;headers&gt;</div><div class="line">&lt;blank line&gt;</div><div class="line">[&lt;response-body&gt;]</div></pre></td></tr></table></figure>
<p>举例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">Server: GitHub.com</div><div class="line">Date: Mon, 06 Nov 2017 11:23:53 GMT</div><div class="line">Content-Type: application/json; charset=utf-8</div><div class="line">Content-Length: 2546</div><div class="line">Status: 200 OK</div><div class="line">X-RateLimit-Limit: 60</div><div class="line">X-RateLimit-Remaining: 46</div><div class="line">X-RateLimit-Reset: 1509969526</div><div class="line">Cache-Control: public, max-age=60, s-maxage=60</div><div class="line">Vary: Accept</div><div class="line">ETag: &quot;7440f7e3c5e6da003d2ef12e02602ef2&quot;</div><div class="line">X-GitHub-Media-Type: github.v3; format=json</div><div class="line">Access-Control-Expose-Headers: ETag, Link, Retry-After, X-GitHub-OTP, X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset, X-OAuth-Scopes, X-Accepted-OAuth-Scopes, X-Poll-Interval</div><div class="line">Access-Control-Allow-Origin: *</div><div class="line">Content-Security-Policy: default-src &apos;none&apos;</div><div class="line">Strict-Transport-Security: max-age=31536000; includeSubdomains; preload</div><div class="line">X-Content-Type-Options: nosniff</div><div class="line">X-Frame-Options: deny</div><div class="line">X-XSS-Protection: 1; mode=block</div><div class="line">X-Runtime-rack: 0.066024</div><div class="line">X-GitHub-Request-Id: 6821:536C:1C4665:50110F:5A004649</div><div class="line"></div><div class="line">[&#123;&quot;url&quot;:&quot;https://api.github.com/repos/4ndroidev/DownloadManager/issues/1&quot;,&quot;repository_url&quot;:&quot;https://api.github.com/repos/4ndroidev/DownloadManager&quot;,&quot;labels_url&quot;:&quot;https://api.github.com/repos/4ndroidev/DownloadManager/issues/1/labels&#123;/name&#125;&quot;,&quot;comments_url&quot;:&quot;https://api.github.com/repos/4ndroidev/DownloadManager/issues/1/comments&quot;,&quot;events_url&quot;:&quot;https://api.github.com/repos/4ndroidev/DownloadManager/issues/1/events&quot;,&quot;html_url&quot;:&quot;https://github.com/4ndroidev/DownloadManager/issues/1&quot;,&quot;id&quot;:265718026,&quot;number&quot;:1,&quot;title&quot;:&quot;State Change&quot;,&quot;user&quot;:&#123;&quot;login&quot;:&quot;Thet-Tun-Aung&quot;,&quot;id&quot;:19220742,&quot;avatar_url&quot;:&quot;https://avatars1.githubusercontent.com/u/19220742?v=4&quot;,&quot;gravatar_id&quot;:&quot;&quot;,&quot;url&quot;:&quot;https://api.github.com/users/Thet-Tun-Aung&quot;,&quot;html_url&quot;:&quot;https://github.com/Thet-Tun-Aung&quot;,&quot;followers_url&quot;:&quot;https://api.github.com/users/Thet-Tun-Aung/followers&quot;,&quot;following_url&quot;:&quot;https://api.github.com/users/Thet-Tun-Aung/following&#123;/other_user&#125;&quot;,&quot;gists_url&quot;:&quot;https://api.github.com/users/Thet-Tun-Aung/gists&#123;/gist_id&#125;&quot;,&quot;starred_url&quot;:&quot;https://api.github.com/users/Thet-Tun-Aung/starred&#123;/owner&#125;&#123;/repo&#125;&quot;,&quot;subscriptions_url&quot;:&quot;https://api.github.com/users/Thet-Tun-Aung/subscriptions&quot;,&quot;organizations_url&quot;:&quot;https://api.github.com/users/Thet-Tun-Aung/orgs&quot;,&quot;repos_url&quot;:&quot;https://api.github.com/users/Thet-Tun-Aung/repos&quot;,&quot;events_url&quot;:&quot;https://api.github.com/users/Thet-Tun-Aung/events&#123;/privacy&#125;&quot;,&quot;received_events_url&quot;:&quot;https://api.github.com/users/Thet-Tun-Aung/received_events&quot;,&quot;type&quot;:&quot;User&quot;,&quot;site_admin&quot;:false&#125;,&quot;labels&quot;:[&#123;&quot;id&quot;:586505191,&quot;url&quot;:&quot;https://api.github.com/repos/4ndroidev/DownloadManager/labels/help%20wanted&quot;,&quot;name&quot;:&quot;help wanted&quot;,&quot;color&quot;:&quot;128A0C&quot;,&quot;default&quot;:true&#125;],&quot;state&quot;:&quot;closed&quot;,&quot;locked&quot;:false,&quot;assignee&quot;:null,&quot;assignees&quot;:[],&quot;milestone&quot;:null,&quot;comments&quot;:2,&quot;created_at&quot;:&quot;2017-10-16T10:18:48Z&quot;,&quot;updated_at&quot;:&quot;2017-10-17T08:56:54Z&quot;,&quot;closed_at&quot;:&quot;2017-10-17T08:56:54Z&quot;,&quot;author_association&quot;:&quot;NONE&quot;,&quot;body&quot;:&quot;How to change state when file doesn&apos;t exit in storage? In order to re-download again.\r\n\r\nissue has been solved by following code:\r\n\r\nDownloadManager  manager = DownloadManager.getInstance();\r\n                        List&lt;DownloadInfo&gt; infos = manager.getAllInfo();\r\n                        for (DownloadInfo info : infos) &#123;\r\n                            if (info.key.equals(task.key)) &#123;\r\n                                manager.delete(info);\r\n                                break;\r\n                            &#125;\r\n                        &#125;\r\n\r\n                        downloadAdapter.notifyItemChanged(position);\r\n\r\n\r\nthanks @4ndroidev &quot;&#125;]</div></pre></td></tr></table></figure>
<ol>
<li>第一行，状态行，说明 http 版本，响应状态码以及响应状态信息</li>
<li>第二行开始为响应头信息，直至空行</li>
<li>空行</li>
<li>最后为响应内容，可能为空</li>
</ol>
<hr>
<h2 id="socket-进程通讯"><a href="#socket-进程通讯" class="headerlink" title="socket 进程通讯"></a>socket 进程通讯</h2><p>android 进程间通讯除了 binder 通讯，还有另外一种比较常见的 socket 通讯，在 native 层出现比较多。如果你想更深入 android 系统，应该克隆一份 aosp 源码。对着系统源码，你将更容易理解其中奥妙。虽然本人 c++ 语言比较差，但看着代码也能理解其用意，和仿照系统源码学习编写 c++ 代码（jni编程）。文章接下来比较多贴代码的地方，需要仔细阅读<strong>代码注释</strong>。</p>
<p>在 android 系统，socket 通讯为 c/s 模式，其中服务器在 init 进程 fork 各个 service 进程时创建，即 socket 服务器依附于 service 进程，而客户端在运行时连接服务器。</p>
<p>一般情况下，我们只关注以下 socket 提供的函数，下文涉及。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建 socket</span></div><div class="line">__<span class="function">socketcall <span class="keyword">int</span> <span class="title">socket</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">// 服务端关注的 bind，accept，listen 函数</span></div><div class="line">__<span class="function">socketcall <span class="keyword">int</span> <span class="title">bind</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">const</span> struct sockaddr*, <span class="keyword">int</span>)</span></span>;</div><div class="line">__<span class="function">socketcall <span class="keyword">int</span> <span class="title">accept</span><span class="params">(<span class="keyword">int</span>, struct sockaddr*, <span class="keyword">socklen_t</span>*)</span></span>;</div><div class="line">__<span class="function">socketcall <span class="keyword">int</span> <span class="title">listen</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">// 客户端关注 connect 函数</span></div><div class="line">__<span class="function">socketcall <span class="keyword">int</span> <span class="title">connect</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">const</span> struct sockaddr*, <span class="keyword">socklen_t</span>)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">// 服务端与客户端都关注的收发数据函数</span></div><div class="line"><span class="function"><span class="keyword">extern</span> ssize_t <span class="title">send</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">const</span> <span class="keyword">void</span>*, <span class="keyword">size_t</span>, <span class="keyword">int</span>)</span></span>;</div><div class="line"><span class="function"><span class="keyword">extern</span> ssize_t <span class="title">recv</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">void</span>*, <span class="keyword">size_t</span>, <span class="keyword">int</span>)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">// 当然还有一个关闭函数</span></div><div class="line">close(<span class="keyword">int</span>)</div></pre></td></tr></table></figure>
<h3 id="服务器启动"><a href="#服务器启动" class="headerlink" title="服务器启动"></a>服务器启动</h3><p>这里描述的服务启动不单单是 socket 服务器启动，而是整个服务进程创建和启动过程，包含三个步骤：</p>
<ol>
<li>脚本解释</li>
<li>启动服务</li>
<li>程序运行</li>
</ol>
<p>其中第二步，启动服务，才是真正从 init 进程 fork 出服务进程，并创建相关的 socket 服务器。</p>
<h4 id="脚本解释"><a href="#脚本解释" class="headerlink" title="脚本解释"></a><strong>脚本解释</strong></h4><p>在 android 启动时，init 进程开始执行初始化，其中会解释 init.rc 并执行，在 init.rc 引入其他 rc 格式脚本文件，其中有服务声明，部分服务带有 socket 声明。研究三星上锁时涉及到 vold 进程，因此下文将围绕 vold 进程相关 socket 知识展开。</p>
<p>vold.rc 脚本 - <strong>system/vold/vold.rc</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">service vold /system/bin/vold \</div><div class="line">        --blkid_context=u:r:blkid:s0 --blkid_untrusted_context=u:r:blkid_untrusted:s0 \</div><div class="line">        --fsck_context=u:r:fsck:s0 --fsck_untrusted_context=u:r:fsck_untrusted:s0</div><div class="line">    class core</div><div class="line">    socket vold stream 0660 root mount</div><div class="line">    socket cryptd stream 0660 root mount</div><div class="line">    ioprio be 2</div><div class="line">    writepid /dev/cpuset/foreground/tasks</div></pre></td></tr></table></figure>
<p>脚本说明:</p>
<ul>
<li>第1行，创建 vold 服务进程，其中二进制程序为 /system/bin/vold</li>
<li>第2-3行，启动 /system/bin/vold 程序的四个参数，这两行是接着第一行的，属于 service 节点参数</li>
<li>第4行，ServiceManager 会对相应类别的服务执行相应方法，略</li>
<li>第5行，创建名为 vold，类别为流的 socket 服务器，设置权限，用户及用户组，对应文件 /dev/socket/vold</li>
<li>第6行，创建名为 cryptd，类别为流的 socket 服务器，设置权限，用户及用户组，对应文件 /dev/socket/cryptd</li>
<li>第7行，设置 io 优先级，范围 0-7</li>
<li>第8行，fork 调用后得到的子进程号写入到文件 /dev/cpuset/foreground/tasks</li>
</ul>
<p>查看服务进程可通过 ps | grep ${name} 命令， 查看 socket 服务器可通过 ls -l /dev/socket/${name}， 如下图</p>
<p><img src="/images/android-socket/android-ps-ls-vold.png" alt="android-ps-ls-vold.png"></p>
<hr>
<p>init 初始化 - <strong>/system/core/init/init.cpp</strong><br>init 进程乃所有用户进程的始祖，初始化时解释执行 init.rc ，fork 出多个服务子进程</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 获取解释器单例</span></div><div class="line">    Parser&amp; parser = Parser::GetInstance();</div><div class="line">    <span class="comment">// 创建 service, on, import 节点解释器</span></div><div class="line">    parser.AddSectionParser(<span class="string">"service"</span>,<span class="built_in">std</span>::make_unique&lt;ServiceParser&gt;());</div><div class="line">    parser.AddSectionParser(<span class="string">"on"</span>, <span class="built_in">std</span>::make_unique&lt;ActionParser&gt;());</div><div class="line">    parser.AddSectionParser(<span class="string">"import"</span>, <span class="built_in">std</span>::make_unique&lt;ImportParser&gt;());</div><div class="line">    <span class="comment">// 解释执行 init.rc</span></div><div class="line">    parser.ParseConfig(<span class="string">"/init.rc"</span>);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>服务解释器代码 - <strong>system/core/init/service.cpp</strong> :</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 服务解释器可处理的参数列表</span></div><div class="line">Service::OptionHandlerMap::Map&amp; Service::OptionHandlerMap::<span class="built_in">map</span>() <span class="keyword">const</span> &#123;</div><div class="line">    <span class="keyword">constexpr</span> <span class="built_in">std</span>::<span class="keyword">size_t</span> kMax = <span class="built_in">std</span>::numeric_limits&lt;<span class="built_in">std</span>::<span class="keyword">size_t</span>&gt;::max();</div><div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> Map option_handlers = &#123;</div><div class="line">        &#123;<span class="string">"class"</span>,       &#123;<span class="number">1</span>,     <span class="number">1</span>,    &amp;Service::HandleClass&#125;&#125;,</div><div class="line">        &#123;<span class="string">"console"</span>,     &#123;<span class="number">0</span>,     <span class="number">0</span>,    &amp;Service::HandleConsole&#125;&#125;,</div><div class="line">        &#123;<span class="string">"critical"</span>,    &#123;<span class="number">0</span>,     <span class="number">0</span>,    &amp;Service::HandleCritical&#125;&#125;,</div><div class="line">        &#123;<span class="string">"disabled"</span>,    &#123;<span class="number">0</span>,     <span class="number">0</span>,    &amp;Service::HandleDisabled&#125;&#125;,</div><div class="line">        &#123;<span class="string">"group"</span>,       &#123;<span class="number">1</span>,     NR_SVC_SUPP_GIDS + <span class="number">1</span>, &amp;Service::HandleGroup&#125;&#125;,</div><div class="line">        &#123;<span class="string">"ioprio"</span>,      &#123;<span class="number">2</span>,     <span class="number">2</span>,    &amp;Service::HandleIoprio&#125;&#125;,</div><div class="line">        &#123;<span class="string">"keycodes"</span>,    &#123;<span class="number">1</span>,     kMax, &amp;Service::HandleKeycodes&#125;&#125;,</div><div class="line">        &#123;<span class="string">"oneshot"</span>,     &#123;<span class="number">0</span>,     <span class="number">0</span>,    &amp;Service::HandleOneshot&#125;&#125;,</div><div class="line">        &#123;<span class="string">"onrestart"</span>,   &#123;<span class="number">1</span>,     kMax, &amp;Service::HandleOnrestart&#125;&#125;,</div><div class="line">        &#123;<span class="string">"seclabel"</span>,    &#123;<span class="number">1</span>,     <span class="number">1</span>,    &amp;Service::HandleSeclabel&#125;&#125;,</div><div class="line">        &#123;<span class="string">"setenv"</span>,      &#123;<span class="number">2</span>,     <span class="number">2</span>,    &amp;Service::HandleSetenv&#125;&#125;,</div><div class="line">        &#123;<span class="string">"socket"</span>,      &#123;<span class="number">3</span>,     <span class="number">6</span>,    &amp;Service::HandleSocket&#125;&#125;,</div><div class="line">        &#123;<span class="string">"user"</span>,        &#123;<span class="number">1</span>,     <span class="number">1</span>,    &amp;Service::HandleUser&#125;&#125;,</div><div class="line">        &#123;<span class="string">"writepid"</span>,    &#123;<span class="number">1</span>,     kMax, &amp;Service::HandleWritepid&#125;&#125;,</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">return</span> option_handlers;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/** OptionHandlerMap 继承 KeywordMap，数据结构如下:</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * using FunctionInfo = std::tuple&lt;std::size_t, std::size_t, Function&gt;;</span></div><div class="line"><span class="comment"> * using Map = const std::map&lt;std::string, FunctionInfo&gt;;</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * &#123;"class",&#123;1,1,&amp;Service::HandleClass&#125;&#125; </span></div><div class="line"><span class="comment"> * 解释为遇到 class 节点，调用 HandleClass 函数，参数个数最少最多都为1</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * 所有 HandleXXX 函数，基本上是收集信息参数，待 Service::Start 才正式使用这些参数信息</span></div><div class="line"><span class="comment"> */</span></div><div class="line">...</div><div class="line"></div><div class="line"><span class="comment">// 遇到 service 节点，创建 service_ 对象，并解释参数</span></div><div class="line"><span class="keyword">bool</span> ServiceParser::ParseSection(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args,</div><div class="line">                                 <span class="built_in">std</span>::<span class="built_in">string</span>* err) &#123;</div><div class="line">    <span class="keyword">if</span> (args.size() &lt; <span class="number">3</span>) &#123;</div><div class="line">        *err = <span class="string">"services must have a name and a program"</span>;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name = args[<span class="number">1</span>];</div><div class="line">    <span class="keyword">if</span> (!IsValidName(name)) &#123;</div><div class="line">        *err = StringPrintf(<span class="string">"invalid service name '%s'"</span>, name.c_str());</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; str_args(args.begin() + <span class="number">2</span>, args.end());</div><div class="line">    service_ = <span class="built_in">std</span>::make_unique&lt;Service&gt;(name, <span class="string">"default"</span>, str_args);</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 逐行解释</span></div><div class="line"><span class="keyword">bool</span> ServiceParser::ParseLineSection(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args,</div><div class="line">                                     <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; filename, <span class="keyword">int</span> line,</div><div class="line">                                     <span class="built_in">std</span>::<span class="built_in">string</span>* err) <span class="keyword">const</span> &#123;</div><div class="line">    <span class="keyword">return</span> service_ ? service_-&gt;HandleLine(args, err) : <span class="literal">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 添加服务到 ServiceManager</span></div><div class="line"><span class="keyword">void</span> ServiceParser::EndSection() &#123;</div><div class="line">    <span class="keyword">if</span> (service_) &#123;</div><div class="line">        ServiceManager::GetInstance().AddService(<span class="built_in">std</span>::move(service_));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 判断是否有效服务名称</span></div><div class="line"><span class="keyword">bool</span> ServiceParser::IsValidName(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name) <span class="keyword">const</span> &#123;</div><div class="line">    <span class="keyword">if</span> (name.size() &gt; <span class="number">16</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; c : name) &#123;</div><div class="line">        <span class="keyword">if</span> (!<span class="built_in">isalnum</span>(c) &amp;&amp; (c != <span class="string">'_'</span>) &amp;&amp; (c != <span class="string">'-'</span>)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a><strong>启动服务</strong></h4><p>服务启动代码 - <strong>system/core/init/service.cpp</strong> :</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> Service::Start() &#123;</div><div class="line">    ...</div><div class="line">    NOTICE(<span class="string">"Starting service '%s'...\n"</span>, name_.c_str());</div><div class="line"></div><div class="line">    <span class="comment">// fork 写时拷贝，若成功调用一次则返回两个值，子进程返回0，父进程返回子进程标记</span></div><div class="line">    <span class="keyword">pid_t</span> pid = fork();</div><div class="line"></div><div class="line">    <span class="comment">// 子进程相关操作</span></div><div class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</div><div class="line">        umask(<span class="number">077</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 添加二进制程序运行时环境变量，扩展 ENV</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; ei : envvars_) &#123;</div><div class="line">            add_environment(ei.name.c_str(), ei.value.c_str());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 创建相关 socket 服务器</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; si : sockets_) &#123;</div><div class="line">            <span class="keyword">int</span> socket_type = ((si.type == <span class="string">"stream"</span> ? SOCK_STREAM :</div><div class="line">                                (si.type == <span class="string">"dgram"</span> ? SOCK_DGRAM :</div><div class="line">                                 SOCK_SEQPACKET)));</div><div class="line">            <span class="keyword">const</span> <span class="keyword">char</span>* socketcon =</div><div class="line">                !si.socketcon.empty() ? si.socketcon.c_str() : scon.c_str();</div><div class="line"></div><div class="line">            <span class="keyword">int</span> s = create_socket(si.name.c_str(), socket_type, si.perm,</div><div class="line">                                  si.uid, si.gid, socketcon);</div><div class="line">            <span class="keyword">if</span> (s &gt;= <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">// 保存 socket 文件描述符到环境变量中</span></div><div class="line">                PublishSocket(si.name, s);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 写进程号到相关文件</span></div><div class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> pid_str = StringPrintf(<span class="string">"%d"</span>, getpid());</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; file : writepid_files_) &#123;</div><div class="line">            <span class="keyword">if</span> (!WriteStringToFile(pid_str, file)) &#123;</div><div class="line">                ERROR(<span class="string">"couldn't write %s to %s: %s\n"</span>,</div><div class="line">                      pid_str.c_str(), file.c_str(), strerror(errno));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 设置 io 优先级</span></div><div class="line">        <span class="keyword">if</span> (ioprio_class_ != IoSchedClass_NONE) &#123;</div><div class="line">            <span class="keyword">if</span> (android_set_ioprio(getpid(), ioprio_class_, ioprio_pri_)) &#123;</div><div class="line">                ERROR(<span class="string">"Failed to set pid %d ioprio = %d,%d: %s\n"</span>,</div><div class="line">                      getpid(), ioprio_class_, ioprio_pri_, strerror(errno));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (needs_console) &#123;</div><div class="line">            setsid();</div><div class="line">            OpenConsole();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            ZapStdio();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        setpgid(<span class="number">0</span>, getpid());</div><div class="line"></div><div class="line">        <span class="comment">// 设置 gid</span></div><div class="line">        <span class="keyword">if</span> (gid_) &#123;</div><div class="line">            <span class="keyword">if</span> (setgid(gid_) != <span class="number">0</span>) &#123;</div><div class="line">                ERROR(<span class="string">"setgid failed: %s\n"</span>, strerror(errno));</div><div class="line">                _exit(<span class="number">127</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 设置关联 gid</span></div><div class="line">        <span class="keyword">if</span> (!supp_gids_.empty()) &#123;</div><div class="line">            <span class="keyword">if</span> (setgroups(supp_gids_.size(), &amp;supp_gids_[<span class="number">0</span>]) != <span class="number">0</span>) &#123;</div><div class="line">                ERROR(<span class="string">"setgroups failed: %s\n"</span>, strerror(errno));</div><div class="line">                _exit(<span class="number">127</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 设置uid</span></div><div class="line">        <span class="keyword">if</span> (uid_) &#123;</div><div class="line">            <span class="keyword">if</span> (setuid(uid_) != <span class="number">0</span>) &#123;</div><div class="line">                ERROR(<span class="string">"setuid failed: %s\n"</span>, strerror(errno));</div><div class="line">                _exit(<span class="number">127</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!seclabel_.empty()) &#123;</div><div class="line">            <span class="keyword">if</span> (setexeccon(seclabel_.c_str()) &lt; <span class="number">0</span>) &#123;</div><div class="line">                ERROR(<span class="string">"cannot setexeccon('%s'): %s\n"</span>,</div><div class="line">                      seclabel_.c_str(), strerror(errno));</div><div class="line">                _exit(<span class="number">127</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; expanded_args;</div><div class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">char</span>*&gt; strs;</div><div class="line">        expanded_args.resize(args_.size());</div><div class="line">        strs.push_back(<span class="keyword">const_cast</span>&lt;<span class="keyword">char</span>*&gt;(args_[<span class="number">0</span>].c_str()));</div><div class="line">        <span class="keyword">for</span> (<span class="built_in">std</span>::<span class="keyword">size_t</span> i = <span class="number">1</span>; i &lt; args_.size(); ++i) &#123;</div><div class="line">            <span class="keyword">if</span> (!expand_props(args_[i], &amp;expanded_args[i])) &#123;</div><div class="line">                ERROR(<span class="string">"%s: cannot expand '%s'\n"</span>, args_[<span class="number">0</span>].c_str(), args_[i].c_str());</div><div class="line">                _exit(<span class="number">127</span>);</div><div class="line">            &#125;</div><div class="line">            strs.push_back(<span class="keyword">const_cast</span>&lt;<span class="keyword">char</span>*&gt;(expanded_args[i].c_str()));</div><div class="line">        &#125;</div><div class="line">        strs.push_back(<span class="literal">nullptr</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 在当前子进程启动二进制执行程序</span></div><div class="line">        <span class="keyword">if</span> (execve(strs[<span class="number">0</span>], (<span class="keyword">char</span>**) &amp;strs[<span class="number">0</span>], (<span class="keyword">char</span>**) ENV) &lt; <span class="number">0</span>) &#123;</div><div class="line">            ERROR(<span class="string">"cannot execve('%s'): %s\n"</span>, strs[<span class="number">0</span>], strerror(errno));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        _exit(<span class="number">127</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</div><div class="line">        ERROR(<span class="string">"failed to start '%s'\n"</span>, name_.c_str());</div><div class="line">        pid_ = <span class="number">0</span>;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>创建 socket 服务器 - <strong>system/core/init/util.cpp</strong><br>此处 socket 服务器仅完成了 bind 操作，而 listen 和 accept 操作在二进制程序运行时才执行</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">create_socket</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> type, <span class="keyword">mode_t</span> perm, <span class="keyword">uid_t</span> uid,</span></span></div><div class="line"><span class="function"><span class="params">                  <span class="keyword">gid_t</span> gid, <span class="keyword">const</span> <span class="keyword">char</span> *socketcon)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">addr</span>;</span></div><div class="line">    <span class="keyword">int</span> fd, ret, savederrno;</div><div class="line">    <span class="keyword">char</span> *filecon; <span class="comment">// 自 Android 支持 SeLinux 之后很多代码都加入这些安全检测操作</span></div><div class="line"></div><div class="line">    <span class="comment">// 设置 selinux context</span></div><div class="line">    <span class="keyword">if</span> (socketcon) &#123;</div><div class="line">        <span class="keyword">if</span> (setsockcreatecon(socketcon) == <span class="number">-1</span>) &#123;</div><div class="line">            ERROR(<span class="string">"setsockcreatecon(\"%s\") failed: %s\n"</span>, socketcon, strerror(errno));</div><div class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 获取 socket 文件描述符</span></div><div class="line">    fd = socket(PF_UNIX, type, <span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</div><div class="line">        ERROR(<span class="string">"Failed to open socket '%s': %s\n"</span>, name, strerror(errno));</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (socketcon)</div><div class="line">        setsockcreatecon(<span class="literal">NULL</span>);</div><div class="line"></div><div class="line">    <span class="comment">// 赋值 sockaddr_um，文件地址格式：/dev/socket/$&#123;name&#125;</span></div><div class="line">    <span class="built_in">memset</span>(&amp;addr, <span class="number">0</span> , <span class="keyword">sizeof</span>(addr));</div><div class="line">    addr.sun_family = AF_UNIX;</div><div class="line">    <span class="built_in">snprintf</span>(addr.sun_path, <span class="keyword">sizeof</span>(addr.sun_path), ANDROID_SOCKET_DI<span class="string">R"/%s"</span>,</div><div class="line">             name);</div><div class="line"></div><div class="line">    ret = unlink(addr.sun_path);</div><div class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span> &amp;&amp; errno != ENOENT) &#123;</div><div class="line">        ERROR(<span class="string">"Failed to unlink old socket '%s': %s\n"</span>, name, strerror(errno));</div><div class="line">        <span class="keyword">goto</span> out_close;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    filecon = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">if</span> (sehandle) &#123;</div><div class="line">        ret = selabel_lookup(sehandle, &amp;filecon, addr.sun_path, S_IFSOCK);</div><div class="line">        <span class="keyword">if</span> (ret == <span class="number">0</span>)</div><div class="line">            setfscreatecon(filecon);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 绑定 socket 到目标地址</span></div><div class="line">    ret = bind(fd, (struct sockaddr *) &amp;addr, <span class="keyword">sizeof</span> (addr));</div><div class="line">    savederrno = errno;</div><div class="line"></div><div class="line">    setfscreatecon(<span class="literal">NULL</span>);</div><div class="line">    freecon(filecon);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ret) &#123;</div><div class="line">        ERROR(<span class="string">"Failed to bind socket '%s': %s\n"</span>, name, strerror(savederrno));</div><div class="line">        <span class="keyword">goto</span> out_unlink;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 设置用户和用户组</span></div><div class="line">    ret = lchown(addr.sun_path, uid, gid);</div><div class="line">    <span class="keyword">if</span> (ret) &#123;</div><div class="line">        ERROR(<span class="string">"Failed to lchown socket '%s': %s\n"</span>, addr.sun_path, strerror(errno));</div><div class="line">        <span class="keyword">goto</span> out_unlink;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 设置权限</span></div><div class="line">    ret = fchmodat(AT_FDCWD, addr.sun_path, perm, AT_SYMLINK_NOFOLLOW);</div><div class="line">    <span class="keyword">if</span> (ret) &#123;</div><div class="line">        ERROR(<span class="string">"Failed to fchmodat socket '%s': %s\n"</span>, addr.sun_path, strerror(errno));</div><div class="line">        <span class="keyword">goto</span> out_unlink;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    INFO(<span class="string">"Created socket '%s' with mode '%o', user '%d', group '%d'\n"</span>,</div><div class="line">         addr.sun_path, perm, uid, gid);</div><div class="line"></div><div class="line">    <span class="comment">// 返回文件描述符，并存入启动二进制程序的环境变量 ENV 中</span></div><div class="line">    <span class="keyword">return</span> fd;</div><div class="line"></div><div class="line">out_unlink:</div><div class="line">    unlink(addr.sun_path);</div><div class="line">out_close:</div><div class="line">    close(fd);</div><div class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="程序运行"><a href="#程序运行" class="headerlink" title="程序运行"></a><strong>程序运行</strong></h4><p>每个服务中 socket 服务器功能不一样，实现可以在 c++ 中，也可以在 java 中，因为 android 提供了 LocalServerSocket, LocalSocket 等类实现 socket 通讯，典型的 java 实现有应用进程的 ZygoteInit。这里以 vold 程序为例，在 c++ 中实现。</p>
<p>在 vold 程序运行时，会创建 VolumeManager 和 NetlinkManager， 并设置 CommandListener，而 CommandListener 是 socket 服务器关键，CommonListener 继承 FrameworkListener，FrameworkListener 继承 SocketListener。从名字可以推断，这里的 socket 通讯主要是用于服务端执行客户端发来的命令，并返回结果，接下来贴代码环节。</p>
<p>vold main 函数 - <strong>system/vold/main.cpp</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    VolumeManager *vm;</div><div class="line">    CommandListener *cl;</div><div class="line">    CryptCommandListener *ccl;</div><div class="line">    NetlinkManager *nm;</div><div class="line"></div><div class="line">    parse_args(argc, argv);</div><div class="line"></div><div class="line">    sehandle = selinux_android_file_context_handle();</div><div class="line">    <span class="keyword">if</span> (sehandle) &#123;</div><div class="line">        selinux_android_set_sehandle(sehandle);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Quickly throw a CLOEXEC on the socket we just inherited from init</span></div><div class="line">    fcntl(android_get_control_socket(<span class="string">"vold"</span>), F_SETFD, FD_CLOEXEC);</div><div class="line">    fcntl(android_get_control_socket(<span class="string">"cryptd"</span>), F_SETFD, FD_CLOEXEC);</div><div class="line"></div><div class="line">    mkdir(<span class="string">"/dev/block/vold"</span>, <span class="number">0755</span>);</div><div class="line"></div><div class="line">    <span class="comment">/* For when cryptfs checks and mounts an encrypted filesystem */</span></div><div class="line">    klog_set_level(<span class="number">6</span>);</div><div class="line"></div><div class="line">    <span class="comment">/* Create our singleton managers */</span></div><div class="line">    <span class="keyword">if</span> (!(vm = VolumeManager::Instance())) &#123;</div><div class="line">        LOG(ERROR) &lt;&lt; <span class="string">"Unable to create VolumeManager"</span>;</div><div class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!(nm = NetlinkManager::Instance())) &#123;</div><div class="line">        LOG(ERROR) &lt;&lt; <span class="string">"Unable to create NetlinkManager"</span>;</div><div class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (property_get_bool(<span class="string">"vold.debug"</span>, <span class="literal">false</span>)) &#123;</div><div class="line">        vm-&gt;setDebug(<span class="literal">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 初始化 CommandListener</span></div><div class="line">    cl = <span class="keyword">new</span> CommandListener();</div><div class="line">    ccl = <span class="keyword">new</span> CryptCommandListener();</div><div class="line">    vm-&gt;setBroadcaster((SocketListener *) cl);</div><div class="line">    nm-&gt;setBroadcaster((SocketListener *) cl);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (vm-&gt;start()) &#123;</div><div class="line">        PLOG(ERROR) &lt;&lt; <span class="string">"Unable to start VolumeManager"</span>;</div><div class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (process_config(vm)) &#123;</div><div class="line">        PLOG(ERROR) &lt;&lt; <span class="string">"Error reading configuration... continuing anyways"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (nm-&gt;start()) &#123;</div><div class="line">        PLOG(ERROR) &lt;&lt; <span class="string">"Unable to start NetlinkManager"</span>;</div><div class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>SocketListener - <strong>system/core/libsysutils/src/SocketListener.cpp</strong><br>职责：listen 和 创建线程进行 accept 客户端</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 启动监听</span></div><div class="line"><span class="keyword">int</span> SocketListener::startListener(<span class="keyword">int</span> backlog) &#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!mSocketName &amp;&amp; mSock == <span class="number">-1</span>) &#123;</div><div class="line">        SLOGE(<span class="string">"Failed to start unbound listener"</span>);</div><div class="line">        errno = EINVAL;</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSocketName) &#123;</div><div class="line">        <span class="comment">// 在 init 创建子进程时 create_socket 函数保存了 socket 的文件描述符到环境变量中，现在取出</span></div><div class="line">        <span class="keyword">if</span> ((mSock = android_get_control_socket(mSocketName)) &lt; <span class="number">0</span>) &#123;</div><div class="line">            SLOGE(<span class="string">"Obtaining file descriptor socket '%s' failed: %s"</span>,</div><div class="line">                 mSocketName, strerror(errno));</div><div class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">        &#125;</div><div class="line">        SLOGV(<span class="string">"got mSock = %d for %s"</span>, mSock, mSocketName);</div><div class="line">        fcntl(mSock, F_SETFD, FD_CLOEXEC);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// socket 服务器进行监听</span></div><div class="line">    <span class="keyword">if</span> (mListen &amp;&amp; listen(mSock, backlog) &lt; <span class="number">0</span>) &#123;</div><div class="line">        SLOGE(<span class="string">"Unable to listen on socket (%s)"</span>, strerror(errno));</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mListen)</div><div class="line">        mClients-&gt;push_back(<span class="keyword">new</span> SocketClient(mSock, <span class="literal">false</span>, mUseCmdNum));</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (pipe(mCtrlPipe)) &#123;</div><div class="line">        SLOGE(<span class="string">"pipe failed (%s)"</span>, strerror(errno));</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 创建无限循环的线程，接受客户端的连入</span></div><div class="line">    <span class="keyword">if</span> (pthread_create(&amp;mThread, <span class="literal">NULL</span>, SocketListener::threadStart, <span class="keyword">this</span>)) &#123;</div><div class="line">        SLOGE(<span class="string">"pthread_create (%s)"</span>, strerror(errno));</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 结束监听</span></div><div class="line"><span class="keyword">int</span> SocketListener::stopListener() &#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (mSocketName &amp;&amp; mSock &gt; <span class="number">-1</span>) &#123;</div><div class="line">        <span class="comment">// 关闭 socket 服务器</span></div><div class="line">        close(mSock);</div><div class="line">        mSock = <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 开启线程</span></div><div class="line"><span class="keyword">void</span> *SocketListener::threadStart(<span class="keyword">void</span> *obj) &#123;</div><div class="line">    SocketListener *me = <span class="keyword">reinterpret_cast</span>&lt;SocketListener *&gt;(obj);</div><div class="line">    me-&gt;runListener();</div><div class="line">    pthread_exit(<span class="literal">NULL</span>);</div><div class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 无限循环接受客户端</span></div><div class="line"><span class="keyword">void</span> SocketListener::runListener() &#123;</div><div class="line"></div><div class="line">    SocketClientCollection pendingList;</div><div class="line"></div><div class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">if</span> (mListen &amp;&amp; FD_ISSET(mSock, &amp;read_fds)) &#123;</div><div class="line">            sockaddr_storage ss;</div><div class="line">            sockaddr* addrp = <span class="keyword">reinterpret_cast</span>&lt;sockaddr*&gt;(&amp;ss);</div><div class="line">            <span class="keyword">socklen_t</span> alen;</div><div class="line">            <span class="keyword">int</span> c;</div><div class="line"></div><div class="line">            <span class="comment">// 接受客户端连入</span></div><div class="line">            <span class="keyword">do</span> &#123;</div><div class="line">                alen = <span class="keyword">sizeof</span>(ss);</div><div class="line">                c = accept(mSock, addrp, &amp;alen);</div><div class="line">                SLOGV(<span class="string">"%s got %d from accept"</span>, mSocketName, c);</div><div class="line">            &#125; <span class="keyword">while</span> (c &lt; <span class="number">0</span> &amp;&amp; errno == EINTR);</div><div class="line">            <span class="keyword">if</span> (c &lt; <span class="number">0</span>) &#123;</div><div class="line">                SLOGE(<span class="string">"accept failed (%s)"</span>, strerror(errno));</div><div class="line">                sleep(<span class="number">1</span>);</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            fcntl(c, F_SETFD, FD_CLOEXEC);</div><div class="line">            pthread_mutex_lock(&amp;mClientsLock);</div><div class="line">            mClients-&gt;push_back(<span class="keyword">new</span> SocketClient(c, <span class="literal">true</span>, mUseCmdNum));</div><div class="line">            pthread_mutex_unlock(&amp;mClientsLock);</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>FrameworkListener - <strong>system/core/libsysutils/src/FrameworkListener.cpp</strong><br>职责：主要负责收发数据，即接收和分发命令，并返回客户端执行结果</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">FrameworkListener::FrameworkListener(<span class="keyword">const</span> <span class="keyword">char</span> *socketName, <span class="keyword">bool</span> withSeq) :</div><div class="line">                            SocketListener(socketName, <span class="literal">true</span>, withSeq) &#123;</div><div class="line">    init(socketName, withSeq);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 接收命令数据</span></div><div class="line"><span class="keyword">bool</span> FrameworkListener::onDataAvailable(SocketClient *c) &#123;</div><div class="line">    <span class="keyword">char</span> buffer[CMD_BUF_SIZE];</div><div class="line">    <span class="keyword">int</span> len;</div><div class="line"></div><div class="line">    <span class="comment">// 读取命令</span></div><div class="line">    len = TEMP_FAILURE_RETRY(read(c-&gt;getSocket(), buffer, <span class="keyword">sizeof</span>(buffer)));</div><div class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</div><div class="line">        SLOGE(<span class="string">"read() failed (%s)"</span>, strerror(errno));</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!len) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (buffer[len<span class="number">-1</span>] != <span class="string">'\0'</span>) &#123;</div><div class="line">        SLOGW(<span class="string">"String is not zero-terminated"</span>);</div><div class="line">        android_errorWriteLog(<span class="number">0x534e4554</span>, <span class="string">"29831647"</span>);</div><div class="line">        c-&gt;sendMsg(<span class="number">500</span>, <span class="string">"Command too large for buffer"</span>, <span class="literal">false</span>);</div><div class="line">        mSkipToNextNullByte = <span class="literal">true</span>;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> offset = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (buffer[i] == <span class="string">'\0'</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mSkipToNextNullByte) &#123;</div><div class="line">                mSkipToNextNullByte = <span class="literal">false</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 分发命令和返回结果</span></div><div class="line">                dispatchCommand(c, buffer + offset);</div><div class="line">            &#125;</div><div class="line">            offset = i + <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mSkipToNextNullByte = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>CommandListener - <strong>system/vold/CommandListener.cpp</strong><br>职责：主要负责注册各种命令解释执行器，统一管理</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">CommandListener::CommandListener() :</div><div class="line">                 FrameworkListener(<span class="string">"vold"</span>, <span class="literal">true</span>) &#123;</div><div class="line">    <span class="comment">// 注册命令解释执行器</span></div><div class="line">    registerCmd(<span class="keyword">new</span> DumpCmd());</div><div class="line">    registerCmd(<span class="keyword">new</span> VolumeCmd());</div><div class="line">    registerCmd(<span class="keyword">new</span> AsecCmd());</div><div class="line">    registerCmd(<span class="keyword">new</span> ObbCmd());</div><div class="line">    registerCmd(<span class="keyword">new</span> StorageCmd());</div><div class="line">    registerCmd(<span class="keyword">new</span> FstrimCmd());</div><div class="line">    registerCmd(<span class="keyword">new</span> AppFuseCmd());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="客户端连接"><a href="#客户端连接" class="headerlink" title="客户端连接"></a>客户端连接</h3><p>客户端可以在 c++ 或 java 中连接，在 vold.rc 中， socket vold 被声明了 0660 权限，即仅 root 用户， mount 组别的客户端才可以连接进行读写，若设有 selinux_label，要求更严格，关注系统安全的同学可以深入学习 SELinux 和 SEAndroid。</p>
<p>在源码中搜索了一番，发现只有 vdc.cpp 程序会发起 vold 的 socket 连接</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> sock;</div><div class="line">    ...</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* sockname = <span class="string">"vold"</span>;</div><div class="line">    <span class="comment">// 不一定 socket vold ，根据参数判断还可能是在同一服务的 socket crypted，可查看 vdc.rc</span></div><div class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"cryptfs"</span>)) &#123;</div><div class="line">        sockname = <span class="string">"cryptd"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 创建客户端，并连接</span></div><div class="line">    <span class="keyword">while</span> ((sock = socket_local_client(sockname,</div><div class="line">                                 ANDROID_SOCKET_NAMESPACE_RESERVED,</div><div class="line">                                 SOCK_STREAM)) &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (!wait_for_socket) &#123;</div><div class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">"Error connecting to %s: %s\n"</span>, sockname, strerror(errno));</div><div class="line">            <span class="built_in">exit</span>(<span class="number">4</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            usleep(<span class="number">10000</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"monitor"</span>)) &#123;</div><div class="line">        <span class="built_in">exit</span>(do_monitor(sock, <span class="number">0</span>));</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">exit</span>(do_cmd(sock, argc, argv));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 写命令</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_cmd</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 通过 sock 文件描述符写字节数据</span></div><div class="line">    <span class="keyword">if</span> (TEMP_FAILURE_RETRY(write(sock, cmd.c_str(), cmd.length() + <span class="number">1</span>)) &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Failed to write command: %s\n"</span>, strerror(errno));</div><div class="line">        <span class="keyword">return</span> errno;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 读取结果</span></div><div class="line">    <span class="keyword">return</span> do_monitor(sock, seq);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 读取结果</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_monitor</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">int</span> stop_after_seq)</span> </span>&#123;</div><div class="line">    <span class="keyword">char</span> buffer[<span class="number">4096</span>];</div><div class="line">    <span class="keyword">int</span> timeout = kCommandTimeoutMs;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (stop_after_seq == <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Connected to vold\n"</span>);</div><div class="line">        timeout = <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">poll_sock</span> = &#123;</span> sock, POLLIN, <span class="number">0</span> &#125;;</div><div class="line">        <span class="keyword">int</span> rc = TEMP_FAILURE_RETRY(poll(&amp;poll_sock, <span class="number">1</span>, timeout));</div><div class="line">        ...</div><div class="line">        <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="keyword">sizeof</span>(buffer));</div><div class="line">        <span class="comment">// 读取字节数据</span></div><div class="line">        rc = TEMP_FAILURE_RETRY(read(sock, buffer, <span class="keyword">sizeof</span>(buffer)));</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> EIO;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="三星上锁"><a href="#三星上锁" class="headerlink" title="三星上锁"></a>三星上锁</h2><blockquote>
<p>这里需要一定的反编译知识，不感兴趣同学直接跳过</p>
</blockquote>
<p>目标应用（官方下载）： crom_service.apk，使用 dex2jar 反编译 dex 得到 jar 文件，使用 jd-gui 查看，可得如图代码结构：</p>
<p><img src="/images/android-socket/android-libkwb-jar.png" alt="android-libkwb-jar.png"></p>
<p>通过静态分析，上图已标记各个 native 方法的功能，同时可发现解锁和上锁的流程如下：</p>
<p><code>上传用户信息和操作命令</code> -&gt; <code>获取操作 token</code> -&gt; <code>校验，解锁或上锁</code></p>
<p>通过 baksmali/smali 工具，干掉 ui 相关代码得到 dex 文件后，再通过 dex2jar 得 jar 文件，新建同包名应用，整理得：</p>
<p><img src="/images/android-socket/android-as-locker.png" alt="android-as-locker.png"></p>
<p>通过 apktool 反编译 apk ，可发现 app 运行时需要是 system 用户和 system 用户组，需在 AndroidManifest.xml 的 manifest 节点添加 <strong>android:sharedUserId=”android.uid.system”</strong>。</p>
<p>问题一：编译运行，没停止运行，报 SEAndroid 权限错误，日志以 <strong>avc:</strong>开头</p>
<p>答案：原因应用签名非官方签名，而是 as 的 debug.keystore。经验证，当安装官方 crom_service.apk，相关的 packageInfo.applicationInfo.seinfo 为 <strong>platform</strong>，而通过 as 安装的是 <strong>default</strong>。看了一下官网介绍，然而并不想研究 SEAndroid ，我比较蠢和是个急性子，遇到这种问题，不先百度，直接就反编译去改 /system/framework/service.jar 里面的 PackageManagerService，赋值 packageInfo.applicationInfo.seinfo 的函数是 <strong>scanPackageDirtyLI</strong>，以下贴的都是官方源码，非三星相应代码，差不多的。</p>
<p>scanPackageDirtyLI - <strong>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageDirtyLI</span><span class="params">(PackageParser.Package pkg,</span></span></div><div class="line"><span class="function"><span class="params">    <span class="keyword">final</span> <span class="keyword">int</span> policyFlags, <span class="keyword">final</span> <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span></span></div><div class="line"><span class="function">    <span class="keyword">throws</span> PackageManagerException </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (mFoundPolicyFile) &#123;</div><div class="line">        SELinuxMMAC.assignSeinfoValue(pkg);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>assignSeinfoValue - <strong>frameworks/base/services/core/java/com/android/server/pm/SELinuxMMAC.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">assignSeinfoValue</span><span class="params">(PackageParser.Package pkg)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (sPolicies) &#123;</div><div class="line">        <span class="keyword">for</span> (Policy policy : sPolicies) &#123;</div><div class="line">            String seinfo = policy.getMatchedSeinfo(pkg);</div><div class="line">            <span class="keyword">if</span> (seinfo != <span class="keyword">null</span>) &#123;</div><div class="line">                pkg.applicationInfo.seinfo = seinfo;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (pkg.applicationInfo.isAutoPlayApp())</div><div class="line">        pkg.applicationInfo.seinfo += AUTOPLAY_APP_STR;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (pkg.applicationInfo.isPrivilegedApp())</div><div class="line">        pkg.applicationInfo.seinfo += PRIVILEGED_APP_STR;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (DEBUG_POLICY_INSTALL) &#123;</div><div class="line">        Slog.i(TAG, <span class="string">"package ("</span> + pkg.packageName + <span class="string">") labeled with "</span> +</div><div class="line">                <span class="string">"seinfo="</span> + pkg.applicationInfo.seinfo);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>先简单粗暴地，判断包名是 <strong>com.sec.android.app.kwb</strong> ，然后直接赋值 <strong>platform</strong> ，相关代码插桩看<a href="https://4ndroidev.github.io/2017/05/02/android-decompile-share-1/#代码插桩"> Android 反编译分享 </a></p>
<p>如果想了解 seinfo 的使用和如何传到 native 层，和应用启动相关，虽然涉及到 LocalSocket 方式与 Zygote 进程通讯，但是展开需要很大的篇幅，这里不作介绍，简单说明是从 <strong>ActivityManagerService.startProcessLocked</strong> 可出发查看源码。</p>
<p>startProcessLocked - <strong>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startProcessLocked</span><span class="params">(ProcessRecord app, String hostingType,</span></span></div><div class="line"><span class="function"><span class="params">            String hostingNameStr, String abiOverride, String entryPoint, String[] entryPointArgs)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">	Process.ProcessStartResult startResult = Process.start(entryPoint,</div><div class="line">        app.processName, uid, uid, gids, debugFlags, mountExternal,</div><div class="line">        app.info.targetSdkVersion, app.info.seinfo, requiredAbi, instructionSet,</div><div class="line">        app.info.dataDir, entryPointArgs);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>问题二：seinfo 对了，权限够了，没报错，但是没效果。</p>
<p>答案：这种情况只能使用屠龙刀 <strong>IDA</strong> 静态分析 <strong>system/lib64/libkwb.so</strong> 了。通过 <strong>IDA</strong> 静态分析后，发现虽然 java 层写的上锁命令是 17， 但是 libkwb.so 只处理 1 和 23 命令，其中 1 是解锁，只要使用 Hex Fiend 将 23 修改为 17 即可。另外在 vold.rc 添加了 socket frigate ，解锁和上锁实质上是修改 /dev/block/steady 文件。上述所有 socket 通讯知识都因 socket frigate 引起我的兴趣而学习得到。</p>
<p><img src="/images/android-socket/android-libkwb-native-unlock.png" alt="android-libkwb-native-unlock.png"></p>
<p>上图为 setTokenToUnlock 对应的 jni 方法，sub_1994 函数是关键，转到 sub_1994 可发现只处理 1 和 23 命令。</p>
<p><img src="/images/android-socket/android-libkwb-sub1994.png" alt="android-libkwb-sub1994.png"></p>
<p>跳到 sub_1994 汇编指令视图，修改指令，其实我也不知道为什么这样改，只是试了几下，指令对了，32位跟64位也不一样。</p>
<p><img src="/images/android-socket/android-libkwb-hex.png" alt="android-libkwb-hex.png"></p>
<p>修改完成，替换 <strong>system/lib64/libkwb.so</strong> ，运行 app ，上锁成功。重启，系统和 recovery 都不能进，只能进入三星挖煤模式-定制 bootloader，bootloader 界面显示 CROM SERVICE : Lock ，成功上锁。朋友说正常现象，上锁后只能刷官方固件才能开机。本人验证了下也是，刷官方系统，确实上锁了，不能刷第三方 recovery。朋友让我试试 knox 和 samsung pay 能不能用，发现是不行的，看来跟上锁没什么关系，听他说可能跟 bootloader 的 WARRANTY VOID 值相关。</p>
<p><img src="/images/android-socket/android-samsung-bl.png" alt="android-samsung-bl.png"></p>
<p>整个过程中，尝试过 cat /dev/block/steady 查看，但是看不出什么，但是可以断点调试 libkwb.so ，懒得使用我那个华硕笔记本调试了，学到知识就好。以后再反编译 knox 和 samsung pay 看看到底校验了什么东西，不让使用。</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p><a href="http://blog.csdn.net/kfanning/article/details/6062118/" target="_blank" rel="external">HTTP请求头详解: http://blog.csdn.net/kfanning/article/details/6062118/</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文主要介绍了 socket 网络编程和进程通讯相关概念和函数，具体的读写操作，协议并没有提及，事实上在 TCP/UDP 网络编程中，还需要考虑传输数据的顺序，边界及丢失等等。更多，请阅读<a href="https://github.com/4ndroidev/4ndroidev.github.io/blob/mobile/source/doc/Java%2BTCPIP%2BSocket%E7%BC%96%E7%A8%8B.pdf" target="_blank" rel="external">《Java+TCPIP+Socket编程.pdf》</a>。</p>

      
    </div>

    
      
      



      
      
    

    
      <footer class="post-footer">
        
        
        
  <nav class="post-nav">
    
    
      <a class="next" href="/2017/10/23/android-coding/">
        <span class="next-text nav-default">Android Coding</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
  </div>


        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:4ndroidev@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/4ndroidev" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
    
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2017

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">4ndroidev</span>
  </span>
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  

  
  




    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.4.x"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.4.x"></script>

    
  </body>
</html>
