<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="Android 实用布局"/>




  <meta name="keywords" content="Android,Layout," />




  <link rel="alternate" href="/atom.xml" title="4ndroidev Note">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.png?v=2.4.x" />



<link rel="canonical" href="http://4ndroidev.github.io/2017/10/09/android-practical-layout/"/>


<meta name="description" content="目录   英文名 中文名     FlowLayout 流式布局   NineGridLayout 九宫格布局   BoundLayout 回弹布局   RefreshLayout 下拉刷新布局    贩剑Q: Github 一堆相应的UI组件库，为什么要重复造轮子? A: 别人的劳斯莱斯轮子未必适合我这破单车。另外，做自己力所能及的事情，多练习也有好处。 基础ViewGroup作为容器类，基本上">
<meta name="keywords" content="Android,Layout">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 实用布局">
<meta property="og:url" content="http://4ndroidev.github.io/2017/10/09/android-practical-layout/index.html">
<meta property="og:site_name" content="4ndroidev Note">
<meta property="og:description" content="目录   英文名 中文名     FlowLayout 流式布局   NineGridLayout 九宫格布局   BoundLayout 回弹布局   RefreshLayout 下拉刷新布局    贩剑Q: Github 一堆相应的UI组件库，为什么要重复造轮子? A: 别人的劳斯莱斯轮子未必适合我这破单车。另外，做自己力所能及的事情，多练习也有好处。 基础ViewGroup作为容器类，基本上">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="http://4ndroidev.github.io/images/android-practical-layout/flowlayout.png">
<meta property="og:image" content="http://4ndroidev.github.io/images/android-practical-layout/ninegridlayout.png">
<meta property="og:image" content="http://4ndroidev.github.io/images/android-practical-layout/boundlayout.gif">
<meta property="og:image" content="http://4ndroidev.github.io/images/android-practical-layout/recyclerview_sample.gif">
<meta property="og:image" content="http://4ndroidev.github.io/images/android-practical-layout/nestedscrollview_sample.gif">
<meta property="og:updated_time" content="2017-10-10T12:29:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android 实用布局">
<meta name="twitter:description" content="目录   英文名 中文名     FlowLayout 流式布局   NineGridLayout 九宫格布局   BoundLayout 回弹布局   RefreshLayout 下拉刷新布局    贩剑Q: Github 一堆相应的UI组件库，为什么要重复造轮子? A: 别人的劳斯莱斯轮子未必适合我这破单车。另外，做自己力所能及的事情，多练习也有好处。 基础ViewGroup作为容器类，基本上">
<meta name="twitter:image" content="http://4ndroidev.github.io/images/android-practical-layout/flowlayout.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.4.x" />







<script>
  var CONFIG = {
    search: false,
    searchPath: "/search.xml",
    fancybox: false,
    toc: true,
  }
</script>




  



    <title> Android 实用布局 · 4ndroidev Note </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">4ndroidev Note</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">4ndroidev Note</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Android 实用布局
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年10月9日
        </span>
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#目录"><span class="toc-text">目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#贩剑"><span class="toc-text">贩剑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基础"><span class="toc-text">基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#样例"><span class="toc-text">样例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FlowLayout"><span class="toc-text">FlowLayout</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NineGridLayout"><span class="toc-text">NineGridLayout</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BoundLayout"><span class="toc-text">BoundLayout</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RefreshLayout"><span class="toc-text">RefreshLayout</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><table>
<thead>
<tr>
<th>英文名</th>
<th>中文名</th>
</tr>
</thead>
<tbody>
<tr>
<td>FlowLayout</td>
<td>流式布局</td>
</tr>
<tr>
<td>NineGridLayout</td>
<td>九宫格布局</td>
</tr>
<tr>
<td>BoundLayout</td>
<td>回弹布局</td>
</tr>
<tr>
<td>RefreshLayout</td>
<td>下拉刷新布局</td>
</tr>
</tbody>
</table>
<h2 id="贩剑"><a href="#贩剑" class="headerlink" title="贩剑"></a>贩剑</h2><p>Q: Github 一堆相应的UI组件库，为什么要重复造轮子?</p>
<p>A: 别人的劳斯莱斯轮子未必适合我这破单车。另外，做自己力所能及的事情，多练习也有好处。</p>
<h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><p><code>ViewGroup</code>作为容器类，基本上布局都继承该类或其子类，重写<code>onMeasure</code>和<code>onLayout</code>方法进行自定义布局。其中官方早已实现五大布局：<code>FrameLayout</code>，<code>LinearLayout</code>，<code>RelativeLayout</code>，<code>TableLayout</code>和<code>AbsoluteLayout</code>。随后，<code>support</code>库也出了不少优秀布局，如<code>ConstraintLayout</code>，<code>CoordinatorLayout</code>等。以上都是官方叼炸天的布局，下面说说作为一个平民，我能做到的布局，由易到难。</p>
<a id="more"></a>
<h2 id="样例"><a href="#样例" class="headerlink" title="样例"></a>样例</h2><p>国际惯例，先上个<code>Sample</code>，让大爷们玩玩。</p>
<p>下载: <a href="http://fir.im/v1j2" target="_blank" rel="external">LayoutSample.apk</a></p>
<p>github: <a href="https://github.com/4ndroidev/LayoutSample" target="_blank" rel="external">https://github.com/4ndroidev/LayoutSample</a></p>
<h2 id="FlowLayout"><a href="#FlowLayout" class="headerlink" title="FlowLayout"></a>FlowLayout</h2><p>描述：相对简单，只需要关注满行后换行操作。<code>onMeasure</code>和<code>onLayout</code>都是一个<code>for</code>循环的操作。另外使用<code>ListAdapter</code>实现子视图适配相对好，不局限于仅适合文本视图，其次在<code>RecyclerView</code>中使用时，<code>ViewHolder</code>的重用也可以达到子视图重用。由于比较简单，直接贴代码。</p>
<p><img src="/images/android-practical-layout/flowlayout.png" alt="flowlayout.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLayout</span> <span class="keyword">extends</span> <span class="title">ViewGroup</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> DEFAULT_VERTICAL_SPACE = <span class="number">10</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> DEFAULT_HORIZONTAL_SPACE = <span class="number">6</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ListAdapter mAdapter;</div><div class="line">    <span class="keyword">private</span> DataSetObserver mObserver = <span class="keyword">new</span> DataSetObserver() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">()</span> </span>&#123;</div><div class="line">            startUpdate();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mVerticalSpace;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mHorizontalSpace;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mRowHeight;</div><div class="line">    <span class="keyword">private</span> OnItemClickListener mOnItemClickListener;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FlowLayout</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FlowLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FlowLayout</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">        <span class="keyword">if</span> (attrs != <span class="keyword">null</span>) &#123;</div><div class="line">            TypedArray array = context.obtainStyledAttributes(attrs, R.styleable.FlowLayout);</div><div class="line">            mVerticalSpace = array.getDimensionPixelOffset(R.styleable.FlowLayout_verticalSpace, DEFAULT_VERTICAL_SPACE);</div><div class="line">            mHorizontalSpace = array.getDimensionPixelOffset(R.styleable.FlowLayout_horizontalSpace, DEFAULT_HORIZONTAL_SPACE);</div><div class="line">            array.recycle();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAdapter</span><span class="params">(ListAdapter adapter)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mAdapter != <span class="keyword">null</span>) &#123;</div><div class="line">            mAdapter.unregisterDataSetObserver(mObserver);</div><div class="line">        &#125;</div><div class="line">        mAdapter = adapter;</div><div class="line">        <span class="keyword">if</span> (mAdapter != <span class="keyword">null</span>) &#123;</div><div class="line">            mAdapter.registerDataSetObserver(mObserver);</div><div class="line">        &#125;</div><div class="line">        startUpdate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> measureWidth = getDefaultSize(<span class="number">0</span>, widthMeasureSpec);</div><div class="line">        <span class="keyword">int</span> paddingHorizontal = getPaddingLeft() + getPaddingRight();</div><div class="line">        <span class="keyword">int</span> paddingVertical = getPaddingTop() + getPaddingBottom();</div><div class="line">        <span class="keyword">int</span> actualWidth = measureWidth - paddingHorizontal;</div><div class="line">        <span class="keyword">int</span> count = getChildCount();</div><div class="line">        <span class="keyword">int</span> freeWidth = actualWidth;</div><div class="line">        <span class="keyword">int</span> row = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">            View child = getChildAt(i);</div><div class="line">            measureChild(child, widthMeasureSpec, heightMeasureSpec);</div><div class="line">            mRowHeight = Math.max(mRowHeight, child.getMeasuredHeight());</div><div class="line">            <span class="keyword">int</span> childWidth = child.getMeasuredWidth();</div><div class="line">            <span class="keyword">int</span> space = freeWidth == actualWidth ? <span class="number">0</span> : mHorizontalSpace;</div><div class="line">            <span class="keyword">if</span> (childWidth + space &gt; freeWidth) &#123;</div><div class="line">                freeWidth = actualWidth - childWidth;</div><div class="line">                row++;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childWidth + space == freeWidth) &#123;</div><div class="line">                freeWidth = actualWidth;</div><div class="line">                row++;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                freeWidth -= childWidth + space;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (freeWidth &lt; actualWidth) row++;</div><div class="line">        setMeasuredDimension(measureWidth, paddingVertical + row * mRowHeight + Math.max(<span class="number">0</span>, row - <span class="number">1</span>) * mVerticalSpace);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> paddingLeft = getPaddingLeft();</div><div class="line">        <span class="keyword">int</span> paddingRight = getPaddingRight();</div><div class="line">        <span class="keyword">int</span> paddingTop = getPaddingTop();</div><div class="line">        <span class="keyword">int</span> row = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> actualWidth = getMeasuredWidth() - paddingLeft - paddingRight;</div><div class="line">        <span class="keyword">int</span> freeWidth = actualWidth;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, count = getChildCount(); i &lt; count; i++) &#123;</div><div class="line">            View child = getChildAt(i);</div><div class="line">            <span class="keyword">int</span> childWidth = child.getMeasuredWidth();</div><div class="line">            <span class="keyword">int</span> childHeight = child.getMeasuredHeight();</div><div class="line">            <span class="keyword">int</span> space = freeWidth == actualWidth ? <span class="number">0</span> : mHorizontalSpace;</div><div class="line">            <span class="keyword">int</span> left, top;</div><div class="line">            <span class="keyword">if</span> (childWidth + space &gt; freeWidth) &#123;</div><div class="line">                freeWidth = actualWidth - childWidth;</div><div class="line">                row++;</div><div class="line">                left = paddingLeft;</div><div class="line">                top = paddingTop + row * mRowHeight + row * mVerticalSpace;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (childWidth + space == freeWidth) &#123;</div><div class="line">                left = actualWidth - freeWidth + space;</div><div class="line">                top = paddingTop + row * mRowHeight + row * mVerticalSpace;</div><div class="line">                freeWidth = actualWidth;</div><div class="line">                row++;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                left = actualWidth - freeWidth + space;</div><div class="line">                top = paddingTop + row * mRowHeight + row * mVerticalSpace;</div><div class="line">                freeWidth -= childWidth + space;</div><div class="line">            &#125;</div><div class="line">            child.layout(left, top, left + childWidth, top + childHeight);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewRemoved</span><span class="params">(View child)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onViewRemoved(child);</div><div class="line">        child.setOnClickListener(<span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewAdded</span><span class="params">(View child)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onViewAdded(child);</div><div class="line">        child.setOnClickListener(v -&gt; &#123;</div><div class="line">            <span class="keyword">if</span> (mOnItemClickListener != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">int</span> position = indexOfChild(child);</div><div class="line">                mOnItemClickListener.onItemClick(<span class="keyword">this</span>, child, position, mAdapter.getItemId(position));</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnItemClickListener</span><span class="params">(OnItemClickListener onItemClickListener)</span> </span>&#123;</div><div class="line">        mOnItemClickListener = onItemClickListener;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startUpdate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mAdapter == <span class="keyword">null</span>) &#123;</div><div class="line">            removeAllViews();</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> expectCount = mAdapter.getCount();</div><div class="line">        <span class="keyword">int</span> childCount = getChildCount();</div><div class="line">        <span class="keyword">if</span> (childCount &gt; expectCount) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = childCount - <span class="number">1</span>; i &gt;= expectCount; i--) &#123;</div><div class="line">                removeViewAt(i);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; expectCount; i++) &#123;</div><div class="line">                mAdapter.getView(i, getChildAt(i), <span class="keyword">this</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">                mAdapter.getView(i, getChildAt(i), <span class="keyword">this</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = childCount; i &lt; expectCount; i++) &#123;</div><div class="line">                addView(mAdapter.getView(i, <span class="keyword">null</span>, <span class="keyword">this</span>));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        requestLayout();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnItemClickListener</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(FlowLayout parent, View view, <span class="keyword">int</span> position, <span class="keyword">long</span> id)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="NineGridLayout"><a href="#NineGridLayout" class="headerlink" title="NineGridLayout"></a>NineGridLayout</h2><p>描述：相对简单，根据容器大小，分成三栏；根据子视图数目布局，特殊地，当子视图数目为一时，视图占两行两列；当子视图数目为四时，分布为两行两列；其余按照三个一排即可。同样适合使用<code>ListAdapter</code>作适配，上代码。</p>
<p><img src="/images/android-practical-layout/ninegridlayout.png" alt="ninegridlayout.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NineGridLayout</span> <span class="keyword">extends</span> <span class="title">ViewGroup</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> DEFAULT_DIVIDER_WIDTH = <span class="number">6</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDividerWidth;</div><div class="line">    <span class="keyword">private</span> ListAdapter mAdapter;</div><div class="line">    <span class="keyword">private</span> DataSetObserver mObserver = <span class="keyword">new</span> DataSetObserver() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">()</span> </span>&#123;</div><div class="line">            startUpdate();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">private</span> OnItemClickListener mOnItemClickListener;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NineGridLayout</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NineGridLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NineGridLayout</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">        <span class="keyword">if</span> (attrs != <span class="keyword">null</span>) &#123;</div><div class="line">            TypedArray array = context.obtainStyledAttributes(attrs, R.styleable.NineGridLayout);</div><div class="line">            mDividerWidth = array.getDimensionPixelOffset(R.styleable.NineGridLayout_dividerWidth, DEFAULT_DIVIDER_WIDTH);</div><div class="line">            array.recycle();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 根据父组件大小，决定子组件大小</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> width = getDefaultSize(<span class="number">0</span>, widthMeasureSpec);</div><div class="line">        <span class="keyword">int</span> itemSize = (<span class="keyword">int</span>) ((width - getPaddingLeft() - getPaddingRight() - <span class="number">2</span> * mDividerWidth) / <span class="number">3.0f</span>);</div><div class="line">        <span class="keyword">if</span> (itemSize &lt; <span class="number">0</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"measureWith must more than the sum of padding and dividerWidth!"</span>);</div><div class="line">        <span class="keyword">int</span> height = getPaddingTop() + getPaddingBottom();</div><div class="line">        <span class="keyword">int</span> count = getChildCount();</div><div class="line">        <span class="keyword">if</span> (count == <span class="number">1</span>) &#123;</div><div class="line">            height += <span class="number">2</span> * itemSize + mDividerWidth;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (count &lt;= <span class="number">3</span>) &#123;</div><div class="line">            height += itemSize;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (count &lt;= <span class="number">6</span>) &#123;</div><div class="line">            height += <span class="number">2</span> * itemSize + mDividerWidth;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            height += <span class="number">3</span> * itemSize + <span class="number">2</span> * mDividerWidth;</div><div class="line">        &#125;</div><div class="line">        setMeasuredDimension(width, height);</div><div class="line">        <span class="keyword">if</span> (count == <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">int</span> singleSize = <span class="number">2</span> * itemSize + mDividerWidth;</div><div class="line">            <span class="keyword">int</span> childWithMeasureSpec = MeasureSpec.makeMeasureSpec(singleSize, MeasureSpec.EXACTLY);</div><div class="line">            <span class="keyword">int</span> childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(singleSize, MeasureSpec.EXACTLY);</div><div class="line">            getChildAt(<span class="number">0</span>).measure(childWithMeasureSpec, childHeightMeasureSpec);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">int</span> childWithMeasureSpec = MeasureSpec.makeMeasureSpec(itemSize, MeasureSpec.EXACTLY);</div><div class="line">            <span class="keyword">int</span> childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(itemSize, MeasureSpec.EXACTLY);</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">                getChildAt(i).measure(childWithMeasureSpec, childHeightMeasureSpec);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> count = getChildCount();</div><div class="line">        <span class="keyword">int</span> columns;</div><div class="line">        <span class="keyword">if</span> (count &lt;= <span class="number">3</span>) &#123;</div><div class="line">            columns = count;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (count == <span class="number">4</span>) &#123;</div><div class="line">            columns = <span class="number">2</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            columns = <span class="number">3</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> paddingLeft = getPaddingLeft();</div><div class="line">        <span class="keyword">int</span> paddingTop = getPaddingTop();</div><div class="line">        <span class="keyword">int</span> paddingRight = getPaddingRight();</div><div class="line">        <span class="keyword">int</span> itemSize = (<span class="keyword">int</span>) ((getMeasuredWidth() - paddingLeft - paddingRight - <span class="number">2</span> * mDividerWidth) / <span class="number">3.0f</span>);</div><div class="line">        <span class="keyword">if</span> (count == <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">int</span> singleSize = <span class="number">2</span> * itemSize + mDividerWidth;</div><div class="line">            getChildAt(<span class="number">0</span>).layout(paddingLeft, paddingTop, paddingLeft + singleSize, paddingTop + singleSize);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">                <span class="keyword">int</span> row = i / columns;</div><div class="line">                <span class="keyword">int</span> column = i % columns;</div><div class="line">                <span class="keyword">int</span> left = paddingLeft + column * (itemSize + mDividerWidth);</div><div class="line">                <span class="keyword">int</span> top = paddingTop + row * (itemSize + mDividerWidth);</div><div class="line">                getChildAt(i).layout(left, top, left + itemSize, top + itemSize);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewRemoved</span><span class="params">(View child)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onViewRemoved(child);</div><div class="line">        child.setOnClickListener(<span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewAdded</span><span class="params">(View child)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onViewAdded(child);</div><div class="line">        child.setOnClickListener(v -&gt; &#123;</div><div class="line">            <span class="keyword">if</span> (mOnItemClickListener != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">int</span> position = indexOfChild(child);</div><div class="line">                mOnItemClickListener.onItemClick(<span class="keyword">this</span>, child, position, mAdapter.getItemId(position));</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnItemClickListener</span><span class="params">(OnItemClickListener onItemClickListener)</span> </span>&#123;</div><div class="line">        mOnItemClickListener = onItemClickListener;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAdapter</span><span class="params">(ListAdapter adapter)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mAdapter != <span class="keyword">null</span>) &#123;</div><div class="line">            mAdapter.unregisterDataSetObserver(mObserver);</div><div class="line">        &#125;</div><div class="line">        mAdapter = adapter;</div><div class="line">        <span class="keyword">if</span> (mAdapter != <span class="keyword">null</span>) &#123;</div><div class="line">            mAdapter.registerDataSetObserver(mObserver);</div><div class="line">        &#125;</div><div class="line">        startUpdate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startUpdate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mAdapter == <span class="keyword">null</span>) &#123;</div><div class="line">            removeAllViews();</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> expectCount = mAdapter.getCount();</div><div class="line">        <span class="keyword">if</span> (expectCount &gt; <span class="number">9</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"NineGridView can host at most 9 children!"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> childCount = getChildCount();</div><div class="line">        <span class="keyword">if</span> (childCount &gt; expectCount) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = childCount - <span class="number">1</span>; i &gt;= expectCount; i--) &#123;</div><div class="line">                removeViewAt(i);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; expectCount; i++) &#123;</div><div class="line">                mAdapter.getView(i, getChildAt(i), <span class="keyword">this</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">                mAdapter.getView(i, getChildAt(i), <span class="keyword">this</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = childCount; i &lt; expectCount; i++) &#123;</div><div class="line">                addView(mAdapter.getView(i, <span class="keyword">null</span>, <span class="keyword">this</span>));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        requestLayout();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnItemClickListener</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(NineGridLayout parent, View view, <span class="keyword">int</span> position, <span class="keyword">long</span> id)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="BoundLayout"><a href="#BoundLayout" class="headerlink" title="BoundLayout"></a>BoundLayout</h2><p>描述：实现目前<code>Bilibili</code>番剧时间表的回弹布局，这种交互用作提示，感觉很友好。并可耻盗用了<code>Bilibili</code>两张图做<code>Demo</code>。相对复杂，上述两简单组件都没涉及手势，该组件涉及到手势处理。大致实现，就是当子视图不能横向或纵向滚动时，拦截手势，使用<code>ViewCompat.offsetLeftAndRight</code>或<code>ViewCompat.offsetTopAndBottom</code>进行横向或纵向偏移视图。代码有500来行，不适合贴全代码，仅上个较通用的手势代码，如果想看全代码，请到<code>github</code></p>
<p>github: <a href="https://github.com/4ndroidev/BoundLayout" target="_blank" rel="external">BoundLayout</a></p>
<p><img src="/images/android-practical-layout/boundlayout.gif" alt="boundlayout.gif"></p>
<p>手势代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!isEnabled()) <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">int</span> action = ev.getActionMasked();</div><div class="line">    <span class="keyword">int</span> pointerIndex;</div><div class="line">    <span class="keyword">switch</span> (action) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</div><div class="line">            mActivePointerId = ev.getPointerId(<span class="number">0</span>);</div><div class="line">            isBeingDragged = <span class="keyword">false</span>;</div><div class="line">            pointerIndex = ev.findPointerIndex(mActivePointerId);</div><div class="line">            <span class="keyword">if</span> (pointerIndex &lt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            mLastMotionX = ev.getX(pointerIndex);</div><div class="line">            mLastMotionY = ev.getY(pointerIndex);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</div><div class="line">            <span class="keyword">if</span> (mActivePointerId == MotionEvent.INVALID_POINTER_ID) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            pointerIndex = ev.findPointerIndex(mActivePointerId);</div><div class="line">            <span class="keyword">if</span> (pointerIndex &lt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            startDragging(ev.getX(pointerIndex), ev.getY(pointerIndex));</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_UP:</div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</div><div class="line">            isBeingDragged = <span class="keyword">false</span>;</div><div class="line">            mActivePointerId = MotionEvent.INVALID_POINTER_ID;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> isBeingDragged;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!isEnabled()) <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">int</span> action = ev.getActionMasked();</div><div class="line">    <span class="keyword">int</span> pointerIndex;</div><div class="line">    <span class="keyword">switch</span> (action) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</div><div class="line">            mActivePointerId = ev.getPointerId(<span class="number">0</span>);</div><div class="line">            isBeingDragged = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</div><div class="line">            pointerIndex = ev.findPointerIndex(mActivePointerId);</div><div class="line">            <span class="keyword">if</span> (pointerIndex &lt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            startDragging(ev.getX(pointerIndex), ev.getY(pointerIndex));</div><div class="line">            <span class="keyword">float</span> x = ev.getX(pointerIndex);</div><div class="line">            <span class="keyword">float</span> y = ev.getY(pointerIndex);</div><div class="line">            <span class="keyword">float</span> value = mOrientation == HORIZONTAL ? x : y;</div><div class="line">            <span class="keyword">float</span> lastValue = mOrientation == HORIZONTAL ? mLastMotionX : mLastMotionY;</div><div class="line">            <span class="keyword">if</span> (isBeingDragged) &#123;</div><div class="line">                <span class="keyword">int</span> offset = (<span class="keyword">int</span>) ((value - lastValue) / DRAGGING_RESISTANCE);</div><div class="line">                <span class="keyword">if</span> (mDirection == DIRECTION_POSITIVE &amp;&amp; mContentOffset + offset &lt; <span class="number">0</span> ||</div><div class="line">                        mDirection == DIRECTION_NEGATIVE &amp;&amp; mContentOffset + offset &gt; <span class="number">0</span>) &#123;</div><div class="line">                    offset = -mContentOffset;</div><div class="line">                &#125;</div><div class="line">                offsetChildren(offset);</div><div class="line">                mLastMotionX = x;</div><div class="line">                mLastMotionY = y;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_UP:</div><div class="line">            <span class="keyword">if</span> (isBeingDragged) &#123;</div><div class="line">                isBeingDragged = <span class="keyword">false</span>;</div><div class="line">                animateOffsetToZero();</div><div class="line">            &#125;</div><div class="line">            mActivePointerId = MotionEvent.INVALID_POINTER_ID;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_POINTER_DOWN: &#123;</div><div class="line">            pointerIndex = ev.getActionIndex();</div><div class="line">            <span class="keyword">if</span> (pointerIndex &lt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            mActivePointerId = ev.getPointerId(pointerIndex);</div><div class="line">            mLastMotionX = ev.getX(pointerIndex);</div><div class="line">            mLastMotionY = ev.getY(pointerIndex);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">case</span> MotionEvent.ACTION_POINTER_UP:</div><div class="line">            pointerIndex = ev.getActionIndex();</div><div class="line">            <span class="keyword">int</span> pointerId = ev.getPointerId(pointerIndex);</div><div class="line">            <span class="keyword">if</span> (pointerId == mActivePointerId) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> newPointerIndex = pointerIndex == <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>;</div><div class="line">                mActivePointerId = ev.getPointerId(newPointerIndex);</div><div class="line">                mLastMotionX = ev.getX(newPointerIndex);</div><div class="line">                mLastMotionY = ev.getY(newPointerIndex);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">canScroll</span><span class="params">(View view, <span class="keyword">float</span> x, <span class="keyword">float</span> y, <span class="keyword">int</span> direction)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (view <span class="keyword">instanceof</span> ViewGroup) &#123;</div><div class="line">        ViewGroup viewGroup = (ViewGroup) view;</div><div class="line">        <span class="keyword">int</span> scrollX = viewGroup.getScrollX();</div><div class="line">        <span class="keyword">int</span> scrollY = viewGroup.getScrollY();</div><div class="line">        <span class="keyword">int</span> count = viewGroup.getChildCount();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</div><div class="line">            View child = viewGroup.getChildAt(i);</div><div class="line">            <span class="keyword">if</span> (x + scrollX &gt;= child.getLeft() &amp;&amp;</div><div class="line">                    x + scrollX &lt; child.getRight() &amp;&amp;</div><div class="line">                    y + scrollY &gt;= child.getTop() &amp;&amp;</div><div class="line">                    y + scrollY &lt; child.getBottom() &amp;&amp;</div><div class="line">                    canScroll(child, x + scrollX - child.getLeft(), y + scrollY - child.getTop(), direction)) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> mOrientation == HORIZONTAL ? view.canScrollHorizontally(direction) : view.canScrollVertically(direction);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startDragging</span><span class="params">(<span class="keyword">float</span> x, <span class="keyword">float</span> y)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (isBeingDragged) <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">if</span> (mOrientation == HORIZONTAL) &#123;</div><div class="line">        startDraggingHorizontal(x, y);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        startDraggingVertical(x, y);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startDraggingHorizontal</span><span class="params">(<span class="keyword">float</span> x, <span class="keyword">float</span> y)</span> </span>&#123;</div><div class="line">    <span class="keyword">float</span> diffX = x - mLastMotionX;</div><div class="line">    <span class="keyword">float</span> diffY = y - mLastMotionY;</div><div class="line">    <span class="keyword">if</span> (Math.abs(diffX) &lt; Math.abs(diffY)) <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">if</span> (diffX &gt; mTouchSlop &amp;&amp; !canScroll(mContent, x, y, DIRECTION_NEGATIVE) ||</div><div class="line">            diffX &lt; -mTouchSlop &amp;&amp; !canScroll(mContent, x, y, DIRECTION_POSITIVE)) &#123;</div><div class="line">        mLastMotionX = mLastMotionX + (diffX &gt; <span class="number">0</span> ? mTouchSlop : -mTouchSlop);</div><div class="line">        mDirection = diffX &gt; <span class="number">0</span> ? DIRECTION_POSITIVE : DIRECTION_NEGATIVE;</div><div class="line">        isBeingDragged = <span class="keyword">true</span>;</div><div class="line">        requestDisallowInterceptTouchEvent(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startDraggingVertical</span><span class="params">(<span class="keyword">float</span> x, <span class="keyword">float</span> y)</span> </span>&#123;</div><div class="line">    <span class="keyword">float</span> diffX = x - mLastMotionX;</div><div class="line">    <span class="keyword">float</span> diffY = y - mLastMotionY;</div><div class="line">    <span class="keyword">if</span> (Math.abs(diffX) &gt; Math.abs(diffY)) <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">if</span> (diffY &gt; mTouchSlop &amp;&amp; !canScroll(mContent, x, y, DIRECTION_NEGATIVE) ||</div><div class="line">            diffY &lt; -mTouchSlop &amp;&amp; !canScroll(mContent, x, y, DIRECTION_POSITIVE)) &#123;</div><div class="line">        mLastMotionY = mLastMotionY + (diffY &gt; <span class="number">0</span> ? mTouchSlop : -mTouchSlop);</div><div class="line">        mDirection = diffY &gt; <span class="number">0</span> ? DIRECTION_POSITIVE : DIRECTION_NEGATIVE;</div><div class="line">        isBeingDragged = <span class="keyword">true</span>;</div><div class="line">        requestDisallowInterceptTouchEvent(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">offsetChildren</span><span class="params">(<span class="keyword">int</span> offset)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (offset == <span class="number">0</span>) <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">if</span> (mOrientation == HORIZONTAL) &#123;</div><div class="line">        offsetHorizontal(offset);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        offsetVertical(offset);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">offsetHorizontal</span><span class="params">(<span class="keyword">int</span> offset)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mHeader != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">int</span> displayMode = ((LayoutParams) mHeader.getLayoutParams()).getDisplayMode();</div><div class="line">        <span class="keyword">if</span> (displayMode == LayoutParams.DISPLAY_MODE_EDGE &amp;&amp; mHeader.getLeft() &lt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mHeader.getLeft() + offset &lt;= <span class="number">0</span>) &#123;</div><div class="line">                mHeaderOffset += offset;</div><div class="line">                ViewCompat.offsetLeftAndRight(mHeader, offset);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mHeaderOffset = <span class="number">0</span>;</div><div class="line">                ViewCompat.offsetLeftAndRight(mHeader, <span class="number">0</span> - mHeader.getLeft());</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (displayMode == LayoutParams.DISPLAY_MODE_SCROLL) &#123;</div><div class="line">            mHeaderOffset += offset;</div><div class="line">            ViewCompat.offsetLeftAndRight(mHeader, offset);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mContent != <span class="keyword">null</span>) &#123;</div><div class="line">        mContentOffset += offset;</div><div class="line">        ViewCompat.offsetLeftAndRight(mContent, offset);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mFooter != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">int</span> displayMode = ((LayoutParams) mFooter.getLayoutParams()).getDisplayMode();</div><div class="line">        <span class="keyword">if</span> (displayMode == LayoutParams.DISPLAY_MODE_EDGE &amp;&amp; mFooter.getRight() &gt;= getMeasuredWidth()) &#123;</div><div class="line">            <span class="keyword">if</span> (mFooter.getRight() + offset &gt;= getMeasuredWidth()) &#123;</div><div class="line">                mFooterOffset += offset;</div><div class="line">                ViewCompat.offsetLeftAndRight(mFooter, offset);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mFooterOffset = <span class="number">0</span>;</div><div class="line">                ViewCompat.offsetLeftAndRight(mFooter, getMeasuredWidth() - mFooter.getRight());</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (displayMode == LayoutParams.DISPLAY_MODE_SCROLL) &#123;</div><div class="line">            mFooterOffset += offset;</div><div class="line">            ViewCompat.offsetLeftAndRight(mFooter, offset);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">offsetVertical</span><span class="params">(<span class="keyword">int</span> offset)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mHeader != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">int</span> displayMode = ((LayoutParams) mHeader.getLayoutParams()).getDisplayMode();</div><div class="line">        <span class="keyword">if</span> (displayMode == LayoutParams.DISPLAY_MODE_EDGE &amp;&amp; mHeader.getTop() &lt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mHeader.getTop() + offset &lt;= <span class="number">0</span>) &#123;</div><div class="line">                mHeaderOffset += offset;</div><div class="line">                ViewCompat.offsetTopAndBottom(mHeader, offset);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mHeaderOffset = <span class="number">0</span>;</div><div class="line">                ViewCompat.offsetTopAndBottom(mHeader, <span class="number">0</span> - mHeader.getTop());</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (displayMode == LayoutParams.DISPLAY_MODE_SCROLL) &#123;</div><div class="line">            mHeaderOffset += offset;</div><div class="line">            ViewCompat.offsetTopAndBottom(mHeader, offset);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mContent != <span class="keyword">null</span>) &#123;</div><div class="line">        mContentOffset += offset;</div><div class="line">        ViewCompat.offsetTopAndBottom(mContent, offset);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mFooter != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">int</span> displayMode = ((LayoutParams) mFooter.getLayoutParams()).getDisplayMode();</div><div class="line">        <span class="keyword">if</span> (displayMode == LayoutParams.DISPLAY_MODE_EDGE &amp;&amp; mFooter.getBottom() &gt;= getMeasuredHeight()) &#123;</div><div class="line">            <span class="keyword">if</span> (mFooter.getBottom() + offset &gt;= getMeasuredHeight()) &#123;</div><div class="line">                mFooterOffset += offset;</div><div class="line">                ViewCompat.offsetTopAndBottom(mFooter, offset);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mFooterOffset = <span class="number">0</span>;</div><div class="line">                ViewCompat.offsetTopAndBottom(mFooter, getMeasuredHeight() - mFooter.getBottom());</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (displayMode == LayoutParams.DISPLAY_MODE_SCROLL) &#123;</div><div class="line">            mFooterOffset += offset;</div><div class="line">            ViewCompat.offsetTopAndBottom(mFooter, offset);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="RefreshLayout"><a href="#RefreshLayout" class="headerlink" title="RefreshLayout"></a>RefreshLayout</h2><p>描述：下拉刷新，挺多人为这个东西搞到头大，官方的<code>SwipeRefreshLaout</code>虽然看上去很好，但是定制能力比较弱，不符合大众口味。众口难调，便出现了一些优秀库，热门的有<a href="https://github.com/liaohuqiu/android-Ultra-Pull-To-Refresh" target="_blank" rel="external">Ultra-Pull-To-Refresh</a>，<a href="https://github.com/scwang90/SmartRefreshLayout" target="_blank" rel="external">🔥SmartRefreshLayout</a>等。</p>
<p>然而我贩剑要自己实现，仅因为我想做一个<code>fling</code>效果自然的下拉刷新，另外嵌套滑动的出现令我意识到做下拉刷新相对容易了。</p>
<p>以下介绍的下拉刷新主要原理就是嵌套滑动，下拉刷新主要涉及的是头部的显示于隐藏，支持嵌套滑动的组件，在<code>onNestedScroll</code>和<code>onNestedPreScroll</code>方法中进行头部的显示和隐藏。而不支持嵌套滑动的组件，可以通过分发手势时，进行类似嵌套滑动处理。另外处理<code>fling</code>时，向下滚动时，先隐藏头部，再进行内容滚动；向上滚动时，先内容滚动，如果时刷新状态，则滚动显示头部。</p>
<p>github: <a href="https://github.com/4ndroidev/RefreshLayout" target="_blank" rel="external">RefreshLayout</a></p>
<p><img src="/images/android-practical-layout/recyclerview_sample.gif" alt="recyclerview_sample.gif"><img src="/images/android-practical-layout/nestedscrollview_sample.gif" alt="nestedscrollview_sample.gif"></p>
<p>由于代码稍微有点多，仅贴嵌套滑动相关代码，其实该部分代码是参照<code>SwipeRefreshLayout</code>的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNestedScrollAccepted</span><span class="params">(View child, View target, <span class="keyword">int</span> axes)</span> </span>&#123;</div><div class="line">    mNestedScrollingParentHelper.onNestedScrollAccepted(child, target, axes);</div><div class="line">    startNestedScroll(axes &amp; ViewCompat.SCROLL_AXIS_VERTICAL);</div><div class="line">    <span class="comment">// set it to current offset</span></div><div class="line">    <span class="comment">// because maybe content view will get a touch down event while flinging hasn't been completed</span></div><div class="line">    mTotalUnconsumed = mCurrentOffset;</div><div class="line">    isNestedScrolling = <span class="keyword">true</span>;</div><div class="line">    isOffset = mCurrentOffset &gt; <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNestedPreScroll</span><span class="params">(View target, <span class="keyword">int</span> dx, <span class="keyword">int</span> dy, <span class="keyword">int</span>[] consumed)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (dy &gt; <span class="number">0</span> &amp;&amp; mTotalUnconsumed &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// make header invisible</span></div><div class="line">        offsetChildren(-Math.min(mTotalUnconsumed, dy));</div><div class="line">        <span class="keyword">if</span> (canRefresh &amp;&amp; mRefreshHeader != <span class="keyword">null</span>) &#123;</div><div class="line">            mRefreshHeader.onPull(mCurrentOffset &gt;= mRefreshThreshold, mCurrentOffset);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (dy &gt; mTotalUnconsumed) &#123;</div><div class="line">            consumed[<span class="number">1</span>] = dy - mTotalUnconsumed;</div><div class="line">            mTotalUnconsumed = <span class="number">0</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mTotalUnconsumed -= dy;</div><div class="line">            consumed[<span class="number">1</span>] = dy;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] parentConsumed = mParentScrollConsumed;</div><div class="line">    <span class="keyword">if</span> (dispatchNestedPreScroll(dx - consumed[<span class="number">0</span>], dy - consumed[<span class="number">1</span>], parentConsumed, <span class="keyword">null</span>)) &#123;</div><div class="line">        consumed[<span class="number">0</span>] += parentConsumed[<span class="number">0</span>];</div><div class="line">        consumed[<span class="number">1</span>] += parentConsumed[<span class="number">1</span>];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNestedScroll</span><span class="params">(View target, <span class="keyword">int</span> dxConsumed, <span class="keyword">int</span> dyConsumed, <span class="keyword">int</span> dxUnconsumed, <span class="keyword">int</span> dyUnconsumed)</span> </span>&#123;</div><div class="line">    dispatchNestedScroll(dxConsumed, dyConsumed, dxUnconsumed, dyUnconsumed, mParentOffsetInWindow);</div><div class="line">    <span class="keyword">int</span> dy = dyUnconsumed + mParentOffsetInWindow[<span class="number">1</span>];</div><div class="line">    <span class="keyword">if</span> (dy &lt; <span class="number">0</span> &amp;&amp; !mContent.canScrollVertically(DIRECTION_NEGATIVE)) &#123;</div><div class="line">        <span class="keyword">if</span> (mCurrentOffset == <span class="number">0</span> &amp;&amp; canRefresh &amp;&amp; mRefreshHeader != <span class="keyword">null</span>) &#123;</div><div class="line">            mRefreshHeader.onPrepare();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> offset = (<span class="keyword">int</span>) (Math.abs(dy) * DRAGGING_RATE);</div><div class="line">        mTotalUnconsumed += offset;</div><div class="line">        <span class="comment">// make header visible</span></div><div class="line">        offsetChildren(offset);</div><div class="line">        <span class="keyword">if</span> (!isOffset) &#123;</div><div class="line">            isOffset = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (canRefresh &amp;&amp; mRefreshHeader != <span class="keyword">null</span>) &#123;</div><div class="line">            mRefreshHeader.onPull(mCurrentOffset &gt;= mRefreshThreshold, mCurrentOffset);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStopNestedScroll</span><span class="params">(View target)</span> </span>&#123;</div><div class="line">    mNestedScrollingParentHelper.onStopNestedScroll(target);</div><div class="line">    isNestedScrolling = <span class="keyword">false</span>;</div><div class="line">    isOffset = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (mCurrentOffset &gt;= mRefreshThreshold) &#123;</div><div class="line">        <span class="keyword">if</span> (canRefresh) &#123;</div><div class="line">            isRefreshing = <span class="keyword">true</span>;</div><div class="line">            canRefresh = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (mRefreshHeader != <span class="keyword">null</span>) mRefreshHeader.onStart();</div><div class="line">            <span class="keyword">if</span> (mListener != <span class="keyword">null</span>) mListener.onRefresh();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (isRefreshing) animateOffsetToRefreshPosition();</div><div class="line">        <span class="keyword">else</span> animateOffsetToStartPosition();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isRefreshing) &#123;</div><div class="line">        <span class="keyword">if</span> (mCurrentOffset &gt; <span class="number">0</span>)</div><div class="line">            animateOffsetToStartPosition();</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            canRefresh = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    stopNestedScroll();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>根据自己需求定制组件，考虑通用性时，切勿过度定制。不要因为太简单而不做，不要因为太难而放弃。</p>

      
    </div>

    
      
      



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/Android/">Android</a>
            
              <a href="/tags/Layout/">Layout</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
    
      <a class="next" href="/2017/09/06/react-native-bundle/">
        <span class="next-text nav-default">react-native bundle 解释与拆解</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
  </div>


        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:4ndroidev@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/4ndroidev" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
    
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2017

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">4ndroidev</span>
  </span>
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  

  
  




    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.4.x"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.4.x"></script>

    
  </body>
</html>
